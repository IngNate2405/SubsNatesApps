<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <script>if (location.protocol === 'http:' && location.hostname !== 'localhost' && !location.hostname.match(/^127\./)) { location.replace('https://' + location.host + location.pathname + location.search); }</script>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover"/>
  <title>Configuraci√≥n - App Suscripciones</title>
  <meta name="description" content="Configuraci√≥n de la aplicaci√≥n">
  <meta name="theme-color" content="#1B1930">
  <link rel="manifest" href="./manifest.json">
  <link rel="apple-touch-icon" href="./icons/icon-192x192.png">
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet"/>
  
  <!-- Scripts de Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  
  <script src="firebase-config.js"></script>
  <script src="firebase-service.js"></script>
  <script src="onesignal-config.js"></script>
  <!-- Cargar configuraci√≥n local si existe (NO se sube a GitHub) -->
  <script src="onesignal-config-local.js" onerror="console.log('onesignal-config-local.js no encontrado (esto es normal)')"></script>
  <script src="version.js"></script>
  
  <!-- OneSignal SDK - Usar m√©todo recomendado con OneSignalDeferred -->
  <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js"></script>
  <script>
    window.OneSignalDeferred = window.OneSignalDeferred || [];
  </script>
  
  <script src="onesignal-service.js"></script>
  <script src="onesignal-session.js"></script>
  
  <style>
    body, html {
      overflow-x: hidden !important;
      overscroll-behavior-x: none;
      max-width: 100vw;
      box-sizing: border-box;
    }
    /* Ocultar scrollbars en m√≥vil */
    body::-webkit-scrollbar, html::-webkit-scrollbar {
      display: none !important;
    }
    body {
      -ms-overflow-style: none;
      scrollbar-width: none !important;
      font-family: 'Inter', sans-serif;
      min-height: 100vh;
      min-height: -webkit-fill-available;
    }
    html {
      height: -webkit-fill-available;
    }
    html, body {
      overflow-y: auto !important;
      -webkit-overflow-scrolling: touch !important;
    }
  </style>
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', async () => {
        // Verificar si estamos en un protocolo soportado
        if (window.location.protocol === 'file:' || window.location.protocol === 'null') {
          console.log('‚ö†Ô∏è Abriendo desde sistema de archivos - Service Worker no disponible');
          console.log('Para usar notificaciones, abre la app desde un servidor web (http/https)');
        } else {
          // Registrar nuestro Service Worker h√≠brido (que incluye el de OneSignal)
          // Este Service Worker combina ambas funcionalidades
          const basePath = window.location.pathname.split('/').slice(0, -1).join('/') || '.';
          const swPath = basePath === '.' ? './sw.js' : `${basePath}/sw.js`;
          navigator.serviceWorker.register(swPath)
            .then(registration => {
              console.log('‚úÖ Service Worker h√≠brido registrado (incluye OneSignal):', registration);
            })
            .catch(error => {
              console.log('Error al registrar ServiceWorker:', error);
            });
        }
      });
    }

    // Funci√≥n para mostrar notificaci√≥n en la p√°gina
    function showNotification(title, message, type = 'success') {
      const colors = {
        success: 'bg-green-500',
        error: 'bg-red-500',
        warning: 'bg-yellow-500',
        info: 'bg-blue-500'
      };
      
      const icons = {
        success: 'fa-check-circle',
        error: 'fa-exclamation-circle',
        warning: 'fa-exclamation-triangle',
        info: 'fa-info-circle'
      };
      
      const notification = document.createElement('div');
      notification.className = `fixed top-4 right-4 ${colors[type] || colors.success} text-white px-6 py-4 rounded-lg shadow-2xl z-[9999] max-w-sm animate-slide-in`;
      notification.style.animation = 'slideIn 0.3s ease-out';
      notification.innerHTML = `
        <div class="flex items-start space-x-3">
          <i class="fas ${icons[type] || icons.success} text-xl flex-shrink-0 mt-0.5"></i>
          <div class="flex-1">
            <strong class="block mb-1 text-base">${title}</strong>
            <div class="text-sm opacity-95">${message}</div>
          </div>
          <button onclick="this.parentElement.parentElement.remove()" class="ml-2 text-white hover:text-gray-200 flex-shrink-0">
            <i class="fas fa-times"></i>
          </button>
        </div>
      `;
      document.body.appendChild(notification);
      
      setTimeout(() => {
        if (notification.parentElement) {
          notification.style.animation = 'slideOut 0.3s ease-out';
          setTimeout(() => {
            if (notification.parentElement) {
              notification.remove();
            }
          }, 300);
        }
      }, 5000);
    }
    
    // Agregar estilos de animaci√≥n
    if (!document.getElementById('notification-styles')) {
      const style = document.createElement('style');
      style.id = 'notification-styles';
      style.textContent = `
        @keyframes slideIn {
          from {
            transform: translateX(100%);
            opacity: 0;
          }
          to {
            transform: translateX(0);
            opacity: 1;
          }
        }
        @keyframes slideOut {
          from {
            transform: translateX(0);
            opacity: 1;
          }
          to {
            transform: translateX(100%);
            opacity: 0;
          }
        }
      `;
      document.head.appendChild(style);
    }

    // Funci√≥n para solicitar permisos de notificaci√≥n
    async function requestNotificationPermission() {
      if ('Notification' in window) {
        const permission = await Notification.requestPermission();
        if (permission === 'granted') {
          // Guardar el estado inmediatamente
          localStorage.setItem('notificationPermission', 'granted');
          document.getElementById('notificationStatus').textContent = 'Permitidas';
          document.getElementById('notificationStatus').className = 'text-green-400';
          showNotification('Permisos concedidos', 'Las notificaciones est√°n ahora activas');
          
          // Notificaciones locales eliminadas - solo usamos OneSignal REST API
        } else if (permission === 'denied') {
          localStorage.setItem('notificationPermission', 'denied');
          document.getElementById('notificationStatus').textContent = 'Denegadas';
          document.getElementById('notificationStatus').className = 'text-red-400';
          showNotification('Permisos denegados', 'Las notificaciones no est√°n disponibles');
        } else {
          localStorage.setItem('notificationPermission', 'default');
          document.getElementById('notificationStatus').textContent = 'No solicitadas';
          document.getElementById('notificationStatus').className = 'text-yellow-400';
        }
      }
    }

    // Funci√≥n para enviar notificaci√≥n de prueba
    async function sendTestNotification() {
      if (!('serviceWorker' in navigator)) {
        showNotification('No disponible', 'Service Worker no est√° disponible');
        return;
      }
      try {
        const registration = await navigator.serviceWorker.ready;
        if (registration.active) {
          registration.active.postMessage({
            type: 'TEST_NOTIFICATION',
            data: {
              title: 'Notificaci√≥n de prueba',
              body: 'Esto es una notificaci√≥n de prueba desde Ajustes'
            }
          });
          showNotification('Enviada', 'Notificaci√≥n de prueba enviada');
        } else {
          showNotification('No disponible', 'Service Worker no est√° activo');
        }
      } catch (error) {
        console.error('Error al enviar notificaci√≥n de prueba:', error);
        showNotification('Error', 'No se pudo enviar la notificaci√≥n de prueba');
      }
    }


    // Funci√≥n para programar notificaciones
    async function scheduleNotifications() {
      if ('serviceWorker' in navigator) {
        try {
          const registration = await navigator.serviceWorker.ready;
          if (registration.active) {
            const subscriptions = JSON.parse(localStorage.getItem('subscriptions') || '[]');
            registration.active.postMessage({
              type: 'SCHEDULE_NOTIFICATIONS',
              subscriptions
            });
            console.log('Mensaje enviado al Service Worker para programar notificaciones');
          } else {
            console.log('Service Worker no est√° activo');
          }
        } catch (error) {
          console.error('Error al programar notificaciones:', error);
        }
      }
    }

    // Funci√≥n para generar opciones de a√±os
    function generateYearOptions() {
      const yearSelector = document.getElementById('yearSelector');
      if (!yearSelector) return;
      
      const currentYear = new Date().getFullYear();
      const selectedYear = localStorage.getItem('selectedYear') || currentYear;
      
      // Generar a√±os desde 2020 hasta 10 a√±os en el futuro
      const startYear = 2024;
      const endYear = currentYear + 10;
      
      yearSelector.innerHTML = '';
      
      for (let year = startYear; year <= endYear; year++) {
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year;
        if (year == selectedYear) {
          option.selected = true;
        }
        yearSelector.appendChild(option);
      }
    }

    // Funci√≥n para guardar el a√±o seleccionado
    function saveYear() {
      const yearSelector = document.getElementById('yearSelector');
      if (!yearSelector) return;
      
      const selectedYear = yearSelector.value;
      localStorage.setItem('selectedYear', selectedYear);
      
      showNotification('A√±o guardado', `El a√±o ${selectedYear} ha sido guardado. El calendario se actualizar√°.`);
      
      console.log('A√±o guardado:', selectedYear);
    }

    // Funci√≥n para obtener el a√±o actual
    function getCurrentYear() {
      return localStorage.getItem('selectedYear') || new Date().getFullYear();
    }

    // Funci√≥n para verificar el estado de las notificaciones
    function checkNotificationStatus() {
      if ('Notification' in window) {
        const permission = Notification.permission;
        const statusElement = document.getElementById('notificationStatus');
        
        if (statusElement) {
          switch(permission) {
            case 'granted':
              statusElement.textContent = 'Permitidas';
              statusElement.className = 'text-green-400';
              // Guardar el estado en localStorage
              localStorage.setItem('notificationPermission', 'granted');
              break;
            case 'denied':
              statusElement.textContent = 'Denegadas';
              statusElement.className = 'text-red-400';
              localStorage.setItem('notificationPermission', 'denied');
              break;
            case 'default':
              statusElement.textContent = 'No solicitadas';
              statusElement.className = 'text-yellow-400';
              localStorage.setItem('notificationPermission', 'default');
              break;
          }
        }
      }
    }

    // Funci√≥n para cargar el estado guardado de las notificaciones
    function loadNotificationStatus() {
      const savedStatus = localStorage.getItem('notificationPermission');
      const statusElement = document.getElementById('notificationStatus');
      
      if (statusElement && savedStatus) {
        switch(savedStatus) {
          case 'granted':
            statusElement.textContent = 'Permitidas';
            statusElement.className = 'text-green-400';
            break;
          case 'denied':
            statusElement.textContent = 'Denegadas';
            statusElement.className = 'text-red-400';
            break;
          case 'default':
            statusElement.textContent = 'No solicitadas';
            statusElement.className = 'text-yellow-400';
            break;
        }
      } else {
        // Si no hay estado guardado, verificar el estado actual
        checkNotificationStatus();
      }
    }

    // Funci√≥n para sincronizar el estado real con el guardado
    function syncNotificationStatus() {
      const statusElement = document.getElementById('notificationStatus');
      const contextWarning = document.getElementById('contextWarning');
      
      if (!statusElement) {
        console.log('‚ùå Elemento notificationStatus no encontrado');
        return;
      }
      
      // Verificar contexto primero
      if (window.location.protocol === 'file:' || window.location.protocol === 'null') {
        statusElement.textContent = 'Contexto no v√°lido';
        statusElement.className = 'text-red-400';
        if (contextWarning) {
          contextWarning.classList.remove('hidden');
        }
        console.log('‚ö†Ô∏è Contexto no v√°lido para notificaciones');
        return;
      } else {
        if (contextWarning) {
          contextWarning.classList.add('hidden');
        }
      }
      
      if ('Notification' in window) {
        const currentPermission = Notification.permission;
        const savedPermission = localStorage.getItem('notificationPermission');
        
        console.log('Estado actual de notificaciones:', currentPermission);
        console.log('Estado guardado:', savedPermission);
        console.log('Elemento encontrado:', statusElement);
        
        // Si el estado guardado es diferente al actual, puede ser que:
        // 1. El usuario cambi√≥ los permisos manualmente en el navegador
        // 2. Los permisos se perdieron por alguna raz√≥n
        // 3. Estamos en un contexto diferente (sistema de archivos vs servidor)
        
        if (savedPermission && savedPermission !== currentPermission) {
          console.log('‚ö†Ô∏è Estado inconsistente detectado');
          console.log('Estado guardado:', savedPermission, 'vs Estado actual:', currentPermission);
          
          // Si ten√≠amos permisos pero ahora no, puede ser por el contexto
          if (savedPermission === 'granted' && currentPermission === 'default') {
            console.log('Los permisos se perdieron - posiblemente por cambio de contexto');
          }
        }
        
        // Actualizar el estado guardado con el actual
        localStorage.setItem('notificationPermission', currentPermission);
        
        // Actualizar la interfaz
        switch(currentPermission) {
          case 'granted':
            statusElement.textContent = 'Permitidas';
            statusElement.className = 'text-green-400';
            break;
          case 'denied':
            statusElement.textContent = 'Denegadas';
            statusElement.className = 'text-red-400';
            break;
          case 'default':
            statusElement.textContent = 'No solicitadas';
            statusElement.className = 'text-yellow-400';
            break;
        }
        
        console.log('Estado actualizado en la interfaz:', currentPermission);
      } else {
        console.log('Notifications API no disponible');
        statusElement.textContent = 'No disponible';
        statusElement.className = 'text-red-400';
      }
    }

    // Funci√≥n para limpiar datos
    function clearAllData() {
      if (confirm('¬øEst√°s seguro de que quieres eliminar todos los datos? Esta acci√≥n no se puede deshacer.')) {
        localStorage.clear();
        showNotification('Datos eliminados', 'Todos los datos han sido eliminados');
      }
    }

    // Funci√≥n para limpiar solo la informaci√≥n de pagos
    function clearPaymentData() {
      if (confirm('¬øEst√°s seguro de que quieres limpiar toda la informaci√≥n de pagos de todas las personas? Esto eliminar√°:\n\n- Todos los registros de pagos (meses, per√≠odos)\n- Comprobantes\n- Estados de pago\n\nLas plataformas y precios se mantendr√°n intactos.')) {
        const personas = JSON.parse(localStorage.getItem('personas') || '[]');
        
        personas.forEach(persona => {
          // Limpiar comprobantes
          persona.comprobantes = [];
          persona.descripcionComprobantes = '';
          
          // Limpiar informaci√≥n de pagos de cada plataforma
          if (persona.plataformas && Array.isArray(persona.plataformas)) {
            persona.plataformas.forEach(plataforma => {
              // Vaciar el array de pagos
              plataforma.pagos = [];
            });
          }
        });
        
        // Guardar las personas actualizadas
        localStorage.setItem('personas', JSON.stringify(personas));
        
        showNotification('Pagos limpiados', 'Se ha limpiado toda la informaci√≥n de pagos. Las plataformas y precios se mantienen intactos.');
      }
    }

    // Funci√≥n para actualizar la versi√≥n
    function updateVersion() {
      const versionElement = document.getElementById('versionNumber');
      const currentVersion = versionElement.textContent.trim();
      
      // Parsear la versi√≥n (formato: X.Y.Z)
      const versionParts = currentVersion.split('.');
      if (versionParts.length === 3) {
        const major = parseInt(versionParts[0]) || 1;
        const minor = parseInt(versionParts[1]) || 0;
        const patch = parseInt(versionParts[2]) || 0;
        
        // Incrementar el patch (√∫ltimo n√∫mero)
        const newPatch = patch + 1;
        const newVersion = `${major}.${minor}.${newPatch}`;
        
        // Actualizar en el DOM
        versionElement.textContent = newVersion;
        
        // Guardar en localStorage para persistencia
        localStorage.setItem('appVersion', newVersion);
        
        showNotification('Versi√≥n actualizada', `Versi√≥n actualizada a ${newVersion}`);
        
        console.log(`Versi√≥n actualizada de ${currentVersion} a ${newVersion}`);
      } else {
        showNotification('Error', 'Formato de versi√≥n no v√°lido');
      }
    }

    // Funci√≥n para comparar versiones (retorna 1 si v1 > v2, -1 si v1 < v2, 0 si iguales)
    function compareVersions(v1, v2) {
      const parts1 = v1.split('.').map(Number);
      const parts2 = v2.split('.').map(Number);
      
      for (let i = 0; i < Math.max(parts1.length, parts2.length); i++) {
        const part1 = parts1[i] || 0;
        const part2 = parts2[i] || 0;
        
        if (part1 > part2) return 1;
        if (part1 < part2) return -1;
      }
      
      return 0;
    }

    // Funci√≥n para incrementar versi√≥n manualmente (solo cuando el usuario lo solicite)
    function incrementarVersion() {
      const versionElement = document.getElementById('versionNumber');
      const currentVersion = versionElement.textContent.trim();
      
      // Parsear la versi√≥n (formato: X.Y.Z)
      const versionParts = currentVersion.split('.');
      if (versionParts.length === 3) {
        const major = parseInt(versionParts[0]) || 1;
        const minor = parseInt(versionParts[1]) || 0;
        const patch = parseInt(versionParts[2]) || 0;
        
        // Incrementar el patch (√∫ltimo n√∫mero)
        const newPatch = patch + 1;
        const newVersion = `${major}.${minor}.${newPatch}`;
        
        // Actualizar en el DOM
        versionElement.textContent = newVersion;
        
        // Guardar en localStorage para persistencia
        localStorage.setItem('appVersion', newVersion);
        
        console.log(`Versi√≥n actualizada de ${currentVersion} a ${newVersion}`);
      }
    }

    // Inicializar cuando el DOM est√© cargado
    // ========== FUNCIONES DE FIREBASE ==========

    async function handleAuth() {
      if (firebaseService.getCurrentUser()) {
        // Ya est√° autenticado, redirigir a login para cerrar sesi√≥n
        window.location.href = 'login.html';
      } else {
        // No est√° autenticado, ir a login
        window.location.href = 'login.html';
      }
    }

    async function migrateToFirebase() {
      const btn = document.getElementById('btn-migrate');
      const originalText = btn.textContent;
      btn.disabled = true;
      btn.textContent = 'Migrando...';

      try {
        await firebaseService.migrateToFirebase();
        showNotification('‚úÖ Datos migrados correctamente a la nube', 'success');
        updateFirebaseUI();
      } catch (error) {
        console.error('Error al migrar:', error);
        let errorMessage = 'Error al migrar datos';
        if (error.message.includes('autenticado')) {
          errorMessage = 'Debes iniciar sesi√≥n primero';
        } else if (error.message.includes('configurado')) {
          errorMessage = 'Firebase no est√° configurado. Revisa firebase-config.js';
        }
        showNotification(errorMessage, 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = originalText;
      }
    }

    async function syncToFirebase() {
      const btn = document.getElementById('btn-sync');
      const originalText = btn.textContent;
      btn.disabled = true;
      btn.textContent = 'Sincronizando...';

      try {
        await firebaseService.syncToFirebase();
        showNotification('‚úÖ Datos sincronizados correctamente', 'success');
      } catch (error) {
        console.error('Error al sincronizar:', error);
        showNotification('Error al sincronizar datos', 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = originalText;
      }
    }


    async function signOut() {
      const dataSource = localStorage.getItem('dataSource') || 'localStorage';
      const user = firebaseService.getCurrentUser();
      
      // Si est√° usando Firebase, preguntar si quiere sincronizar antes de cerrar
      if (user && dataSource === 'firebase' && isFirebaseAvailable()) {
        const sincronizar = confirm('¬øQuieres sincronizar tus cambios antes de cerrar sesi√≥n?');
        
        if (sincronizar) {
          try {
            const btn = document.getElementById('btn-signout');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Sincronizando...';
            
            await firebaseService.syncToFirebase();
            showNotification('‚úÖ Datos sincronizados correctamente', 'success');
            
            btn.disabled = false;
            btn.innerHTML = originalText;
          } catch (error) {
            console.error('Error al sincronizar:', error);
            showNotification('Error al sincronizar: ' + (error.message || 'Error desconocido'), 'error');
            // Continuar con el cierre de sesi√≥n aunque falle la sincronizaci√≥n
          }
        }
      }
      
      // Confirmar cierre de sesi√≥n
      if (confirm('¬øEst√°s seguro de que quieres cerrar sesi√≥n? Se restaurar√°n tus datos locales anteriores y se eliminar√°n los datos de la cuenta actual.')) {
        try {
          // Primero restaurar datos locales desde el backup (esto limpia los datos de Firebase)
          const restored = firebaseService.restoreLocalBackup();
          if (!restored) {
            // Si no hay backup, limpiar completamente los datos de Firebase
            localStorage.setItem('subscriptions', '[]');
            localStorage.setItem('personas', '[]');
            localStorage.setItem('mensajesEnviados', '{}');
            localStorage.setItem('appVersion', '1.0.45');
            localStorage.setItem('notificationPermission', 'default');
            localStorage.setItem('selectedYear', new Date().getFullYear().toString());
          }
          
          // Cerrar sesi√≥n de Firebase
          await firebaseService.signOut();
          
          // Asegurar que dataSource sea localStorage
          localStorage.setItem('dataSource', 'localStorage');
          localStorage.removeItem('firebaseUserId');
          
          showNotification('Sesi√≥n cerrada correctamente. Datos locales restaurados.', 'success');
          
          // Redirigir a login despu√©s de cerrar sesi√≥n
          setTimeout(() => {
            window.location.href = 'login.html';
          }, 1000);
        } catch (error) {
          console.error('Error al cerrar sesi√≥n:', error);
          showNotification('Error al cerrar sesi√≥n: ' + (error.message || 'Error desconocido'), 'error');
        }
      }
    }

    function updateFirebaseUI() {
      const isOnline = isFirebaseAvailable();
      const user = firebaseService.getCurrentUser();
      const dataSource = localStorage.getItem('dataSource') || 'localStorage';

      const syncStatus = document.getElementById('sync-status');
      const syncStatusText = document.getElementById('sync-status-text');
      const authStatusText = document.getElementById('auth-status-text');
      const btnAuth = document.getElementById('btn-auth');
      const migrateSection = document.getElementById('migrate-section');
      const syncSection = document.getElementById('sync-section');
      const signoutSection = document.getElementById('signout-section');

      if (!isOnline) {
        syncStatus.textContent = 'No disponible';
        syncStatus.className = 'text-red-400';
        syncStatusText.textContent = 'Firebase no est√° configurado';
        authStatusText.textContent = 'Firebase no configurado';
        btnAuth.disabled = true;
        migrateSection.classList.add('hidden');
        syncSection.classList.add('hidden');
        if (signoutSection) signoutSection.classList.add('hidden');
        return;
      }

      if (user) {
        syncStatus.textContent = 'Conectado';
        syncStatus.className = 'text-green-400';
        syncStatusText.textContent = 'Sincronizaci√≥n activa';
        authStatusText.textContent = `Autenticado como: ${user.email}`;
        
        // Ocultar bot√≥n de iniciar sesi√≥n/cambiar cuenta cuando hay usuario autenticado
        const authButtonContainer = document.getElementById('auth-button-container');
        if (authButtonContainer) {
          authButtonContainer.classList.add('hidden');
        }
        
        // Mostrar bot√≥n de cerrar sesi√≥n
        if (signoutSection) signoutSection.classList.remove('hidden');
        
        // Si est√° autenticado, mostrar opciones de sincronizaci√≥n
        if (dataSource === 'firebase') {
          migrateSection.classList.add('hidden');
          syncSection.classList.remove('hidden');
        } else {
          migrateSection.classList.remove('hidden');
          syncSection.classList.add('hidden');
        }
      } else {
        syncStatus.textContent = 'Desconectado';
        syncStatus.className = 'text-yellow-400';
        syncStatusText.textContent = 'No autenticado';
        authStatusText.textContent = 'No autenticado';
        btnAuth.textContent = 'Iniciar Sesi√≥n';
        
        // Mostrar bot√≥n de iniciar sesi√≥n cuando no hay usuario
        const authButtonContainer = document.getElementById('auth-button-container');
        if (authButtonContainer) {
          authButtonContainer.classList.remove('hidden');
        }
        
        migrateSection.classList.add('hidden');
        syncSection.classList.add('hidden');
        if (signoutSection) signoutSection.classList.add('hidden');
      }
    }

    // Funci√≥n para verificar estado de OneSignal
    // Flag para evitar m√∫ltiples verificaciones simult√°neas
    let isCheckingOneSignal = false;
    let lastOneSignalStatus = null;

    async function checkOneSignalStatus(showNotifications = false) {
      const statusDiv = document.getElementById('onesignal-status');
      
      if (!statusDiv) {
        console.error('Elemento onesignal-status no encontrado');
        return;
      }

      // Usar sesi√≥n global si est√° disponible (m√°s r√°pido)
      if (typeof window.oneSignalSession !== 'undefined' && window.oneSignalSession.isInitialized()) {
        // Verificar estado usando sesi√≥n global (con cach√©)
        const status = await window.oneSignalSession.checkStatus(!showNotifications);
        if (status) {
          updateOneSignalUI(status);
          // Si se solicita mostrar notificaciones, verificar en segundo plano
          if (showNotifications) {
            // Verificar estado completo en segundo plano
            setTimeout(async () => {
              await checkOneSignalStatusFull(showNotifications);
            }, 100);
          }
          return;
        }
      }

      // Evitar m√∫ltiples verificaciones simult√°neas
      if (isCheckingOneSignal) {
        console.log('‚è≥ Verificaci√≥n de OneSignal ya en progreso, omitiendo...');
        return;
      }

      isCheckingOneSignal = true;
      
      // Continuar con verificaci√≥n completa
      await checkOneSignalStatusFull(showNotifications);
    }

    async function checkOneSignalStatusFull(showNotifications = false) {
      const statusDiv = document.getElementById('onesignal-status');

      // Solo mostrar "Verificando..." si es la primera vez o si se solicita expl√≠citamente
      if (showNotifications || !lastOneSignalStatus) {
        statusDiv.innerHTML = '<div class="text-blue-400">‚è≥ Verificando...</div>';
      }

      // Esperar a que OneSignal SDK est√© disponible (especialmente importante al navegar entre p√°ginas)
      if (typeof OneSignal === 'undefined') {
        // En PWA, el SDK puede tardar m√°s en cargarse
        const isPWA = window.matchMedia('(display-mode: standalone)').matches || 
                     window.navigator.standalone || 
                     document.referrer.includes('android-app://');
        const maxWait = isPWA ? 10000 : 5000; // 10 segundos en PWA, 5 en web normal
        const startTime = Date.now();
        
        // Mostrar mensaje de espera
        if (showNotifications || !lastOneSignalStatus) {
          statusDiv.innerHTML = '<div class="text-blue-400">‚è≥ Esperando a que OneSignal SDK se cargue...</div>';
        }
        
        // Esperar a que el SDK se cargue
        while (typeof OneSignal === 'undefined' && (Date.now() - startTime) < maxWait) {
          await new Promise(resolve => setTimeout(resolve, 200)); // Esperar 200ms entre verificaciones
        }
        
        // Si despu√©s de esperar a√∫n no est√° disponible, mostrar error
        if (typeof OneSignal === 'undefined') {
          statusDiv.innerHTML = `
            <div class="text-yellow-400 mb-2">‚è≥ OneSignal SDK cargando...</div>
            <div class="text-xs text-gray-400">Si el problema persiste, recarga la p√°gina</div>
          `;
          // No mostrar notificaci√≥n de error autom√°ticamente, solo si se solicita expl√≠citamente
          if (showNotifications) {
            showNotification('‚è≥ Esperando...', 'OneSignal SDK se est√° cargando, por favor espera...', 'info');
          }
          isCheckingOneSignal = false;
          // Intentar de nuevo despu√©s de un momento
          setTimeout(() => {
            if (typeof OneSignal !== 'undefined') {
              checkOneSignalStatus(showNotifications);
            }
          }, 2000);
          return;
        }
      }

      if (!oneSignalService) {
        statusDiv.innerHTML = '<div class="text-red-400">‚ùå OneSignal Service no disponible</div>';
        if (showNotifications) {
          showNotification('‚ùå Error', 'OneSignal Service no disponible', 'error');
        }
        isCheckingOneSignal = false;
        return;
      }

      if (!ONESIGNAL_CONFIG || !ONESIGNAL_CONFIG.appId || ONESIGNAL_CONFIG.appId === 'TU_ONESIGNAL_APP_ID') {
        statusDiv.innerHTML = `
          <div class="text-yellow-400 mb-2">‚ö†Ô∏è OneSignal no configurado</div>
          <div class="text-xs text-gray-400">Configura tu App ID en onesignal-config.js</div>
        `;
        if (showNotifications) {
          showNotification('‚ö†Ô∏è Advertencia', 'Configura tu App ID de OneSignal en onesignal-config.js', 'warning');
        }
        isCheckingOneSignal = false;
        return;
      }

      try {
        // Solo inicializar si no est√° ya inicializado
        if (!oneSignalService.initialized) {
          console.log('üîß Inicializando OneSignal...');
          const initialized = await oneSignalService.initialize(ONESIGNAL_CONFIG.appId, ONESIGNAL_CONFIG.safariWebId);
          if (!initialized) {
            statusDiv.innerHTML = '<div class="text-red-400">‚ùå Error al inicializar OneSignal</div>';
            isCheckingOneSignal = false;
            return;
          }
        } else {
          console.log('‚úÖ OneSignal ya est√° inicializado, solo verificando estado...');
        }

        // Obtener informaci√≥n del usuario
        const userInfo = await oneSignalService.getUserInfo();
        const currentStatus = userInfo && userInfo.subscribed ? 'subscribed' : 
                             (userInfo && userInfo.permission === 'denied' ? 'denied' : 'not_subscribed');
        
        // Solo actualizar UI y mostrar notificaciones si el estado cambi√≥ o si se solicita expl√≠citamente
        const statusChanged = lastOneSignalStatus !== currentStatus;
        
        if (userInfo && userInfo.subscribed) {
          statusDiv.innerHTML = `
            <div class="text-green-400 mb-2">‚úÖ Suscrito a OneSignal</div>
            <div class="text-xs text-gray-400">Las notificaciones funcionar√°n incluso con el navegador cerrado</div>
          `;
          if (showNotifications && statusChanged) {
            showNotification('‚úÖ Verificado', 'Est√°s suscrito a OneSignal. Las notificaciones funcionar√°n con el navegador cerrado.', 'success');
          }
        } else if (userInfo && userInfo.permission === 'denied') {
          statusDiv.innerHTML = `
            <div class="text-red-400 mb-2">‚ùå Permisos denegados</div>
            <div class="text-xs text-gray-400">Habilita las notificaciones en la configuraci√≥n del navegador</div>
          `;
          if (showNotifications && statusChanged) {
            showNotification('‚ùå Permisos denegados', 'Habilita las notificaciones en la configuraci√≥n del navegador', 'error');
          }
        } else {
          statusDiv.innerHTML = `
            <div class="text-yellow-400 mb-2">‚ö†Ô∏è No suscrito</div>
            <div class="text-xs text-gray-400">Haz clic en "Suscribirse" para activar las notificaciones</div>
          `;
        }

        lastOneSignalStatus = currentStatus;
      } catch (error) {
        console.error('Error verificando OneSignal:', error);
        statusDiv.innerHTML = `
          <div class="text-red-400 mb-2">‚ùå Error: ${error.message || 'Error desconocido'}</div>
          <div class="text-xs text-gray-400 mt-1">Revisa la consola para m√°s detalles</div>
        `;
        if (showNotifications) {
          showNotification('‚ùå Error', `Error al verificar: ${error.message || 'Error desconocido'}`, 'error');
        }
      } finally {
        isCheckingOneSignal = false;
        // Actualizar sesi√≥n global con el estado obtenido
        if (typeof window.oneSignalSession !== 'undefined') {
          const userInfo = await oneSignalService.getUserInfo();
          if (userInfo && userInfo.subscribed) {
            window.oneSignalSession.status = 'subscribed';
          } else if (userInfo && userInfo.permission === 'denied') {
            window.oneSignalSession.status = 'denied';
          } else {
            window.oneSignalSession.status = 'not_subscribed';
          }
          window.oneSignalSession.lastCheck = Date.now();
        }
      }
    }

    // Funci√≥n para suscribirse a OneSignal
    async function subscribeToOneSignal() {
      const statusDiv = document.getElementById('onesignal-status');
      
      // Verificar si OneSignal SDK est√° cargado, si no, esperar m√°s tiempo
      if (typeof OneSignal === 'undefined') {
        if (statusDiv) {
          statusDiv.innerHTML = '<div class="text-yellow-400">‚è≥ Esperando a que OneSignal SDK se cargue...</div>';
        }
        showNotification('‚è≥ Esperando...', 'OneSignal SDK se est√° cargando, por favor espera...', 'info');
        
        // Esperar hasta 30 segundos en PWA
        const isPWA = window.matchMedia('(display-mode: standalone)').matches || 
                     window.navigator.standalone || 
                     document.referrer.includes('android-app://');
        const maxWait = isPWA ? 30000 : 15000;
        const startTime = Date.now();
        
        while (typeof OneSignal === 'undefined' && (Date.now() - startTime) < maxWait) {
          await new Promise(resolve => setTimeout(resolve, 1000));
        }
        
        if (typeof OneSignal === 'undefined') {
          if (statusDiv) {
            statusDiv.innerHTML = '<div class="text-red-400">‚ùå OneSignal SDK no se carg√≥. Recarga la p√°gina o verifica tu conexi√≥n.</div>';
          }
          showNotification('‚ùå Error', 'OneSignal SDK no se carg√≥. Recarga la p√°gina.', 'error');
          return;
        }
      }

      if (!oneSignalService) {
        if (statusDiv) {
          statusDiv.innerHTML = '<div class="text-red-400">‚ùå OneSignal Service no disponible</div>';
        }
        showNotification('‚ùå Error', 'OneSignal Service no est√° disponible', 'error');
        return;
      }

      if (!ONESIGNAL_CONFIG || !ONESIGNAL_CONFIG.appId || ONESIGNAL_CONFIG.appId === 'TU_ONESIGNAL_APP_ID') {
        if (statusDiv) {
          statusDiv.innerHTML = '<div class="text-yellow-400">‚ö†Ô∏è Configura tu App ID en onesignal-config.js</div>';
        }
        showNotification('‚ö†Ô∏è Advertencia', 'Configura tu App ID de OneSignal en onesignal-config.js', 'warning');
        return;
      }

      try {
        if (statusDiv) {
          statusDiv.innerHTML = '<div class="text-blue-400">‚è≥ Suscribiendo...</div>';
        }
        
        showNotification('‚è≥ Suscribiendo...', 'Configurando OneSignal...', 'info');
        
        // Asegurar que OneSignal est√© inicializado
        if (!oneSignalService.initialized) {
          const initialized = await oneSignalService.initialize(ONESIGNAL_CONFIG.appId, ONESIGNAL_CONFIG.safariWebId);
          if (!initialized) {
            if (statusDiv) {
              statusDiv.innerHTML = '<div class="text-red-400">‚ùå Error al inicializar OneSignal</div>';
            }
            showNotification('‚ùå Error', 'No se pudo inicializar OneSignal', 'error');
            return;
          }
        }
        
        const subscribed = await oneSignalService.subscribe();
        
        if (subscribed) {
          showNotification('‚úÖ √âxito', 'Suscrito a OneSignal correctamente. Las notificaciones funcionar√°n incluso con el navegador cerrado.', 'success');
          // Actualizar estado despu√©s de un momento (mostrar notificaciones porque es acci√≥n del usuario)
          setTimeout(() => {
            checkOneSignalStatus(true);
          }, 1000);
        } else {
          if (statusDiv) {
            statusDiv.innerHTML = '<div class="text-yellow-400">‚ö†Ô∏è Permisos denegados. Habilita las notificaciones en la configuraci√≥n del navegador.</div>';
          }
          showNotification('‚ö†Ô∏è Permisos denegados', 'Habilita las notificaciones en la configuraci√≥n del navegador', 'warning');
        }
      } catch (error) {
        console.error('Error al suscribirse:', error);
        if (statusDiv) {
          statusDiv.innerHTML = `<div class="text-red-400">‚ùå Error: ${error.message || 'Error desconocido'}</div>`;
        }
        showNotification('‚ùå Error', `Error: ${error.message || 'Error desconocido'}`, 'error');
      }
    }

    function saveOneSignalRestApiKey() {
      const input = document.getElementById('onesignal-rest-api-key-input');
      const statusEl = document.getElementById('onesignal-key-status');
      if (!input || !statusEl) return;
      const key = (input.value || '').trim();
      if (!key) {
        statusEl.textContent = 'Escribe o pega la clave y pulsa Guardar clave.';
        statusEl.className = 'text-xs mt-2 text-yellow-400';
        return;
      }
      try {
        localStorage.setItem('onesignal_rest_api_key', key);
        statusEl.textContent = '‚úÖ Clave guardada. Los recordatorios se enviar√°n a OneSignal al guardar suscripciones.';
        statusEl.className = 'text-xs mt-2 text-green-400';
        input.value = '';
        input.placeholder = 'Clave guardada (vuelve a pegar para cambiar)';
        showNotification('‚úÖ Clave guardada', 'Los recordatorios se enviar√°n a OneSignal al guardar.', 'success');
      } catch (e) {
        statusEl.textContent = '‚ùå No se pudo guardar: ' + (e.message || 'error');
        statusEl.className = 'text-xs mt-2 text-red-400';
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      console.log('DOM cargado, verificando estado de notificaciones...');
      
      // Detectar iOS y mostrar instrucciones si es necesario
      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) || 
                   (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
      const isStandalone = window.matchMedia('(display-mode: standalone)').matches || 
                         window.navigator.standalone;
      
      if (isIOS && !isStandalone) {
        const iosInstructions = document.getElementById('ios-instructions');
        if (iosInstructions) {
          iosInstructions.classList.remove('hidden');
        }
      }
      
      // Cargar versi√≥n
      cargarVersion();

      // Mostrar si ya hay clave REST guardada (para recordatorios)
      const keyStatusEl = document.getElementById('onesignal-key-status');
      if (keyStatusEl && localStorage.getItem('onesignal_rest_api_key')) {
        keyStatusEl.textContent = '‚úÖ Tienes una clave guardada. Los recordatorios se env√≠an a OneSignal al guardar.';
        keyStatusEl.className = 'text-xs mt-2 text-green-400';
      }
      
      // Verificar estado inmediatamente (sin mostrar notificaciones)
      syncNotificationStatus();
      // Verificar OneSignal usando sesi√≥n global (m√°s r√°pido)
      // Si ya est√° inicializado, usar cach√©; si no, inicializar
      if (typeof window.oneSignalSession !== 'undefined' && window.oneSignalSession.isInitialized()) {
        // Usar estado en cach√© para mostrar inmediatamente
        const cachedStatus = window.oneSignalSession.getCachedStatus();
        if (cachedStatus) {
          updateOneSignalUI(cachedStatus);
        }
        // Verificar en segundo plano (sin bloquear)
        setTimeout(() => {
          checkOneSignalStatus(false);
        }, 100);
      } else {
        // Esperar un poco para que el SDK tenga tiempo de cargarse
        setTimeout(() => {
          checkOneSignalStatus(false);
        }, 500);
      }
      updateFirebaseUI();

      // Escuchar cambios de autenticaci√≥n
      if (isFirebaseAvailable()) {
        firebaseService.onAuthStateChanged(() => {
          updateFirebaseUI();
        });
      }
      
      // Inicializar OneSignal solo si no est√° ya inicializado
      // Verificar si OneSignal ya est√° inicializado globalmente
      const isOneSignalAlreadyInitialized = () => {
        // Verificar si oneSignalService ya est√° inicializado
        if (oneSignalService && oneSignalService.initialized) {
          return true;
        }
        // Verificar si OneSignal SDK ya est√° inicializado
        if (typeof OneSignal !== 'undefined' && OneSignal.SDK_VERSION) {
          try {
            // Si OneSignal tiene User, probablemente ya est√° inicializado
            if (OneSignal.User) {
              return true;
            }
          } catch (e) {
            // Si hay error, probablemente no est√° inicializado
          }
        }
        return false;
      };

      // Usar sesi√≥n global para evitar re-inicializaciones
      if (typeof window.oneSignalSession === 'undefined') {
        console.warn('‚ö†Ô∏è oneSignalSession no disponible, cargando...');
        // Esperar un momento y verificar de nuevo
        setTimeout(() => {
          if (typeof window.oneSignalSession !== 'undefined') {
            initializeOneSignalWithSession();
          } else {
            // Fallback a m√©todo anterior
            initializeOneSignalLegacy();
          }
        }, 500);
      } else {
        initializeOneSignalWithSession();
      }

      async function initializeOneSignalWithSession() {
        // Verificar si ya est√° inicializado en la sesi√≥n
        if (window.oneSignalSession.isInitialized()) {
          console.log('‚úÖ OneSignal ya est√° inicializado en sesi√≥n global, verificando estado...');
          // Verificar estado usando cach√© (r√°pido)
          const cachedStatus = window.oneSignalSession.getCachedStatus();
          if (cachedStatus) {
            updateOneSignalUI(cachedStatus);
          }
          // Verificar estado en segundo plano (sin bloquear)
          setTimeout(() => {
            checkOneSignalStatus(false);
          }, 100);
          return;
        }

        // Verificar configuraci√≥n
        if (!ONESIGNAL_CONFIG || !ONESIGNAL_CONFIG.appId || ONESIGNAL_CONFIG.appId === 'TU_ONESIGNAL_APP_ID') {
          const statusDiv = document.getElementById('onesignal-status');
          if (statusDiv) {
            statusDiv.innerHTML = '<div class="text-yellow-400">‚ö†Ô∏è Configura tu App ID en onesignal-config.js</div>';
          }
          return;
        }

        // Inicializar usando sesi√≥n global (solo una vez)
        try {
          const statusDiv = document.getElementById('onesignal-status');
          if (statusDiv) {
            statusDiv.innerHTML = '<div class="text-blue-400">‚è≥ Inicializando OneSignal...</div>';
          }

          const initialized = await window.oneSignalSession.initializeOnce(
            ONESIGNAL_CONFIG.appId, 
            ONESIGNAL_CONFIG.safariWebId
          );
          
          if (initialized) {
            // Verificar estado despu√©s de inicializar - sin notificaciones
            setTimeout(() => {
              checkOneSignalStatus(false);
            }, 500);
          } else {
            const statusDiv = document.getElementById('onesignal-status');
            if (statusDiv) {
              statusDiv.innerHTML = '<div class="text-red-400">‚ùå Error al inicializar OneSignal. Revisa la consola para m√°s detalles.</div>';
            }
          }
        } catch (error) {
          console.error('Error inicializando OneSignal:', error);
          const statusDiv = document.getElementById('onesignal-status');
          if (statusDiv) {
            statusDiv.innerHTML = `<div class="text-red-400">‚ùå Error: ${error.message || 'Error desconocido'}</div>`;
          }
        }
      }

      function initializeOneSignalLegacy() {
        // M√©todo anterior como fallback
        if (isOneSignalAlreadyInitialized()) {
          console.log('‚úÖ OneSignal ya est√° inicializado, verificando estado...');
          setTimeout(() => {
            checkOneSignalStatus(false);
          }, 500);
          return;
        }

        const isPWA = window.matchMedia('(display-mode: standalone)').matches || 
                     window.navigator.standalone || 
                     document.referrer.includes('android-app://');
        const waitTime = isPWA ? 5000 : 3000;
        
        setTimeout(async () => {
          if (isOneSignalAlreadyInitialized()) {
            checkOneSignalStatus(false);
            return;
          }

          if (!oneSignalService || !ONESIGNAL_CONFIG || ONESIGNAL_CONFIG.appId === 'TU_ONESIGNAL_APP_ID') {
            return;
          }

          try {
            await oneSignalService.initialize(ONESIGNAL_CONFIG.appId, ONESIGNAL_CONFIG.safariWebId);
            setTimeout(() => {
              checkOneSignalStatus(false);
            }, 1000);
          } catch (error) {
            console.error('Error inicializando OneSignal:', error);
          }
        }, waitTime);
      }

      function updateOneSignalUI(status) {
        const statusDiv = document.getElementById('onesignal-status');
        if (!statusDiv) return;

        switch(status) {
          case 'subscribed':
            statusDiv.innerHTML = `
              <div class="text-green-400 mb-2">‚úÖ Suscrito a OneSignal</div>
              <div class="text-xs text-gray-400">Las notificaciones funcionar√°n incluso con el navegador cerrado</div>
            `;
            break;
          case 'denied':
            statusDiv.innerHTML = `
              <div class="text-red-400 mb-2">‚ùå Permisos denegados</div>
              <div class="text-xs text-gray-400">Habilita las notificaciones en la configuraci√≥n del navegador</div>
            `;
            break;
          case 'not_subscribed':
            statusDiv.innerHTML = `
              <div class="text-yellow-400 mb-2">‚ö†Ô∏è No suscrito</div>
              <div class="text-xs text-gray-400">Haz clic en "Suscribirse" para activar las notificaciones</div>
            `;
            break;
        }
      }
      
      // Sincronizar estado cuando la p√°gina vuelve a estar visible (sin notificaciones)
      document.addEventListener('visibilitychange', () => {
        if (!document.hidden) {
          console.log('P√°gina visible, sincronizando estado...');
          syncNotificationStatus();
          // Verificar OneSignal usando sesi√≥n global (m√°s r√°pido, usa cach√©)
          if (typeof window.oneSignalSession !== 'undefined' && window.oneSignalSession.isInitialized()) {
            // Verificar estado en segundo plano (sin bloquear UI)
            setTimeout(() => {
              checkOneSignalStatus(false);
            }, 100);
          }
        }
      });
      
      // Generar opciones de a√±os
      generateYearOptions();
      
      // Actualizar contadores
      const subscriptions = JSON.parse(localStorage.getItem('subscriptions') || '[]');
      const personas = JSON.parse(localStorage.getItem('personas') || '[]');
      
      document.getElementById('totalSubscriptions').textContent = subscriptions.length;
      // Contar solo personas activas
      const personasActivas = personas.filter(p => !p.desuscrita).length;
      document.getElementById('totalPersonas').textContent = personasActivas;
      
      // Actualizar versi√≥n usando el sistema centralizado
      cargarVersion();
    });

    function showClearOptions() {
      const choice = prompt('¬øQu√© deseas borrar?\n1 = Solo cach√©\n2 = Solo datos\n3 = Cach√© y datos\n(Cancelar para no hacer nada)');
      if (!choice) return;
      if (choice === '1') {
        clearCacheAndUpdate(false);
      } else if (choice === '2') {
        clearCacheAndUpdate(true, true);
      } else if (choice === '3') {
        clearCacheAndUpdate(true);
      } else {
        alert('Opci√≥n no v√°lida.');
      }
    }

    async function clearCacheAndUpdate(clearData = false, onlyData = false) {
      try {
        console.log('Iniciando limpieza de cach√©...', { clearData, onlyData });
        
        if (clearData) {
          console.log('Limpiando localStorage...');
          localStorage.clear();
        }
        
        if (!onlyData) {
          // Limpiar cach√©
          if ('caches' in window) {
            try {
              console.log('Obteniendo nombres de cach√©...');
              const cacheNames = await caches.keys();
              console.log('Cach√©s encontrados:', cacheNames);
              await Promise.all(cacheNames.map(name => caches.delete(name)));
              console.log('Cach√© limpiado correctamente');
            } catch (error) {
              console.error('Error al limpiar cach√©:', error);
            }
          }
          
          // Desregistrar Service Workers
          if ('serviceWorker' in navigator) {
            try {
              console.log('Desregistrando Service Workers...');
              const registrations = await navigator.serviceWorker.getRegistrations();
              console.log('Service Workers encontrados:', registrations.length);
              for (let reg of registrations) {
                await reg.unregister();
              }
              console.log('Service Workers desregistrados correctamente');
            } catch (error) {
              console.error('Error al desregistrar Service Workers:', error);
            }
          }
        }
        
        console.log('Limpieza completada, recargando p√°gina...');
        // Recargar la p√°gina despu√©s de un peque√±o delay para asegurar que todo se procese
        setTimeout(() => {
          window.location.reload(true);
        }, 100);
      } catch (error) {
        console.error('Error en clearCacheAndUpdate:', error);
        alert('Error al limpiar cach√©: ' + error.message + '\nPor favor, intenta recargar la p√°gina manualmente.');
      }
    }

    // Bloquear pinch zoom
    document.addEventListener('gesturestart', function (e) { e.preventDefault(); });
    document.addEventListener('gesturechange', function (e) { e.preventDefault(); });
    document.addEventListener('gestureend', function (e) { e.preventDefault(); });
    // Bloquear doble tap zoom
    let lastTouchEnd = 0;
    document.addEventListener('touchend', function (event) {
      const now = (new Date()).getTime();
      if (now - lastTouchEnd <= 300) {
        event.preventDefault();
      }
      lastTouchEnd = now;
    }, false);
  </script>
</head>
<body class="bg-[#0D0A1A] text-white min-h-screen flex flex-col justify-between">
  <div class="container mx-auto px-4 pt-4 pb-20">
    <div class="flex items-center justify-between mb-8">
      <h1 class="text-3xl font-extrabold leading-tight">Configuraci√≥n</h1>
      <button onclick="window.location.href='index.html'" class="text-gray-400 hover:text-white">
        <i class="fas fa-arrow-left text-xl"></i>
      </button>
    </div>

    <!-- Secci√≥n de Notificaciones -->
    <div class="bg-[#1B1930] rounded-xl p-6 mb-6">
      <h2 class="text-xl font-bold mb-4">Notificaciones</h2>
      
      <!-- Advertencia de contexto -->
      <div id="contextWarning" class="hidden bg-yellow-600/20 border border-yellow-600/30 rounded-lg p-4 mb-4">
        <div class="flex items-start space-x-3">
          <i class="fas fa-exclamation-triangle text-yellow-400 mt-1"></i>
          <div>
            <h3 class="font-semibold text-yellow-400 mb-2">Contexto no v√°lido para notificaciones</h3>
            <p class="text-yellow-300 text-sm mb-3">
              Est√°s abriendo la aplicaci√≥n desde el sistema de archivos. Las notificaciones push requieren un servidor web (http/https).
            </p>
            <div class="text-yellow-300 text-sm">
              <p class="font-semibold mb-1">Para usar notificaciones:</p>
              <ul class="list-disc list-inside space-y-1">
                <li>Usa un servidor local como Live Server en VS Code</li>
                <li>O sube la app a un servidor web</li>
                <li>O usa herramientas como Python: <code class="bg-yellow-600/30 px-1 rounded">python -m http.server</code></li>
              </ul>
            </div>
          </div>
        </div>
      </div>
      
      <div class="space-y-4">
        <div class="flex justify-between items-center">
          <div>
            <h3 class="font-semibold">Estado de notificaciones</h3>
            <p class="text-gray-400 text-sm">Permisos del navegador</p>
          </div>
          <span id="notificationStatus" class="text-yellow-400">Verificando...</span>
        </div>
        
        <div class="flex justify-between items-center">
          <div>
            <h3 class="font-semibold">Solicitar permisos</h3>
            <p class="text-gray-400 text-sm">Activar notificaciones push</p>
          </div>
          <button onclick="requestNotificationPermission()" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg text-sm">
            Solicitar
          </button>
        </div>
        <div class="flex justify-between items-center">
          <div>
            <h3 class="font-semibold">Notificaci√≥n de prueba</h3>
            <p class="text-gray-400 text-sm">Verifica que las notificaciones funcionan</p>
          </div>
          <button onclick="sendTestNotification()" class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded-lg text-sm">
            Enviar
          </button>
        </div>
        
        <!-- Informaci√≥n sobre Notificaciones -->
        <div class="border-t border-gray-700 pt-4 mt-4">
          <h3 class="font-semibold mb-3">Push Notifications (OneSignal)</h3>
          
          <div id="push-status" class="p-3 bg-[#2a2736] rounded-lg text-sm">
            <div id="onesignal-status" class="text-yellow-400 mb-2">‚è≥ Verificando estado...</div>
            <div class="mt-3 space-y-2">
              <button onclick="subscribeToOneSignal()" class="bg-purple-600 hover:bg-purple-700 px-4 py-2 rounded-lg text-sm w-full">
                Suscribirse a Notificaciones Push
              </button>
              <button onclick="checkOneSignalStatus(true)" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg text-sm w-full">
                Verificar Estado
              </button>
            </div>
            <div class="mt-4 p-3 bg-[#2a2736] rounded-lg border border-gray-600">
              <label class="block text-sm font-medium text-gray-300 mb-2">Clave REST API (recordatorios al guardar)</label>
              <p class="text-xs text-gray-400 mb-2">Si los recordatorios no se env√≠an a OneSignal, pega aqu√≠ tu clave. OneSignal ‚Üí Settings ‚Üí Keys &amp; IDs ‚Üí REST API Key.</p>
              <input type="password" id="onesignal-rest-api-key-input" placeholder="Pega la clave REST API" class="w-full px-3 py-2 rounded bg-[#1a1722] border border-gray-600 text-sm text-gray-200 placeholder-gray-500 mb-2"/>
              <button onclick="saveOneSignalRestApiKey()" class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded-lg text-sm w-full">Guardar clave</button>
              <p id="onesignal-key-status" class="text-xs mt-2"></p>
            </div>
            <div class="text-xs text-gray-400 mt-3">
              üí° OneSignal es 100% gratuito hasta 10,000 suscriptores
            </div>
            <div class="text-xs text-gray-500 mt-1">
              ‚úÖ Funciona incluso cuando el navegador est√° cerrado
            </div>
            <!-- Instrucciones para iOS -->
            <div id="ios-instructions" class="hidden mt-4 p-4 bg-blue-900/30 rounded-lg border border-blue-700">
              <div class="text-blue-300 font-semibold mb-2">üì± Para iOS (iPhone/iPad):</div>
              <div class="text-xs text-blue-200 space-y-2">
                <p>1. Abre esta p√°gina en Safari, Chrome o Edge</p>
                <p>2. Toca el bot√≥n <strong>Compartir</strong> (cuadrado con flecha)</p>
                <p>3. Selecciona <strong>"Agregar a pantalla de inicio"</strong></p>
                <p>4. Abre la app desde la pantalla de inicio (no desde el navegador)</p>
                <p>5. Luego podr√°s suscribirte a las notificaciones</p>
              </div>
            </div>
          </div>
        </div>
        
        <div class="flex justify-between items-center mt-4">
          <button onclick="if(confirm('¬øEst√°s seguro de que quieres eliminar el cach√©? Esto recargar√° la aplicaci√≥n.')) { clearCacheAndUpdate(false); }" class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded-lg text-sm w-full">Eliminar cach√©</button>
        </div>
      </div>
    </div>

    <!-- Secci√≥n de Mensajer√≠a -->
    <div class="bg-[#1B1930] rounded-xl p-6 mb-6">
      <h2 class="text-xl font-bold mb-4">Mensajer√≠a</h2>
      
      <div class="space-y-4">
        <div class="flex justify-between items-center">
          <div>
            <h3 class="font-semibold">Generar mensajes</h3>
            <p class="text-gray-400 text-sm">Crear mensajes personalizados para usuarios</p>
          </div>
          <button onclick="window.location.href='mensajeria.html'" class="bg-purple-600 hover:bg-purple-700 px-4 py-2 rounded-lg text-sm w-24">
            Abrir
          </button>
        </div>
      </div>
    </div>

    <!-- Secci√≥n de Cotizar -->
    <div class="bg-[#1B1930] rounded-xl p-6 mb-6">
      <h2 class="text-xl font-bold mb-4">Cotizar</h2>
      
      <div class="space-y-4">
        <div class="flex justify-between items-center">
          <div>
            <h3 class="font-semibold">Calcular precios y ganancias</h3>
            <p class="text-gray-400 text-sm">Cotizar suscripciones compartidas</p>
          </div>
          <button onclick="window.location.href='cotizar.html'" class="bg-indigo-600 hover:bg-indigo-700 px-4 py-2 rounded-lg text-sm w-24">
            Abrir
          </button>
        </div>
      </div>
    </div>

    <!-- Secci√≥n de Iconos de Suscripciones -->
    <div class="bg-[#1B1930] rounded-xl p-6 mb-6">
      <h2 class="text-xl font-bold mb-4">Iconos de Suscripciones</h2>
      
      <div class="space-y-4">
        <div class="flex justify-between items-center">
          <div>
            <h3 class="font-semibold">Gestionar iconos globales</h3>
            <p class="text-gray-400 text-sm">Agregar y gestionar iconos para usar en suscripciones</p>
          </div>
          <button onclick="window.location.href='iconos-suscripciones.html'" class="bg-purple-600 hover:bg-purple-700 px-4 py-2 rounded-lg text-sm w-24">
            Abrir
          </button>
        </div>
      </div>
    </div>

    <!-- Secci√≥n de Dashboard -->
    <div class="bg-[#1B1930] rounded-xl p-6 mb-6">
      <h2 class="text-xl font-bold mb-4">Dashboard y M√©tricas</h2>
      
      <div class="space-y-4">
        <div class="flex justify-between items-center">
          <div>
            <h3 class="font-semibold">Ver m√©tricas y estad√≠sticas</h3>
            <p class="text-gray-400 text-sm">An√°lisis de suscripciones, gastos e ingresos</p>
          </div>
          <button onclick="window.location.href='dashboard.html'" class="bg-indigo-600 hover:bg-indigo-700 px-4 py-2 rounded-lg text-sm w-24">
            Abrir
          </button>
        </div>
      </div>
    </div>

    <!-- Secci√≥n de Desuscripci√≥n de Personas -->
    <div class="bg-[#1B1930] rounded-xl p-6 mb-6">
      <h2 class="text-xl font-bold mb-4">Desuscripci√≥n de Personas</h2>
      
      <div class="space-y-4">
        <div class="flex justify-between items-center">
          <div>
            <h3 class="font-semibold">Gestionar desuscripciones</h3>
            <p class="text-gray-400 text-sm">Marcar personas como desuscritas</p>
          </div>
          <button onclick="window.location.href='desuscripcion.html'" class="bg-orange-600 hover:bg-orange-700 px-4 py-2 rounded-lg text-sm w-24">
            Abrir
          </button>
        </div>
      </div>
    </div>

    <!-- Secci√≥n de Sincronizaci√≥n en la Nube -->
    <div class="bg-[#1B1930] rounded-xl p-6 mb-6">
      <h2 class="text-xl font-bold mb-4">Sincronizaci√≥n en la Nube</h2>
      
      <div class="space-y-4">
        <div class="flex justify-between items-center">
          <div>
            <h3 class="font-semibold">Estado de sincronizaci√≥n</h3>
            <p class="text-gray-400 text-sm" id="sync-status-text">Verificando...</p>
          </div>
          <span id="sync-status" class="text-yellow-400">-</span>
        </div>

        <div id="auth-section" class="space-y-3">
          <div class="flex justify-between items-center" id="auth-button-container">
            <div>
              <h3 class="font-semibold">Autenticaci√≥n</h3>
              <p class="text-gray-400 text-sm" id="auth-status-text">No autenticado</p>
            </div>
            <button onclick="handleAuth()" id="btn-auth" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg text-sm">
              Iniciar Sesi√≥n
            </button>
          </div>
        </div>

        <div id="migrate-section" class="hidden">
          <div class="bg-yellow-600/20 border border-yellow-600/30 rounded-lg p-4 mb-4">
            <div class="flex items-start space-x-3">
              <i class="fas fa-info-circle text-yellow-400 mt-1"></i>
              <div>
                <h3 class="font-semibold text-yellow-400 mb-2">Migrar datos a la nube</h3>
                <p class="text-yellow-300 text-sm">
                  Esto copiar√° todos tus datos actuales (suscripciones, personas, mensajes) a Firebase. 
                  Tus datos locales se mantendr√°n como respaldo.
                </p>
              </div>
            </div>
          </div>
          <button onclick="migrateToFirebase()" id="btn-migrate" class="w-full bg-green-600 hover:bg-green-700 px-4 py-2 rounded-lg text-sm">
            Migrar datos a la nube
          </button>
        </div>

        <div id="sync-section" class="hidden">
          <button onclick="syncToFirebase()" id="btn-sync" class="w-full bg-purple-600 hover:bg-purple-700 px-4 py-2 rounded-lg text-sm">
            <i class="fas fa-sync-alt mr-2"></i>
            Sincronizar ahora
          </button>
        </div>
        
        <!-- Bot√≥n de cerrar sesi√≥n siempre visible cuando est√° autenticado -->
        <div id="signout-section" class="hidden mt-4">
          <button onclick="signOut()" id="btn-signout" class="w-full bg-red-600 hover:bg-red-700 px-4 py-2 rounded-lg text-sm flex items-center justify-center space-x-2">
            <i class="fas fa-sign-out-alt"></i>
            <span>Cerrar Sesi√≥n</span>
          </button>
        </div>
      </div>
    </div>

    <!-- Secci√≥n de Datos -->
    <div class="bg-[#1B1930] rounded-xl p-6 mb-6">
      <h2 class="text-xl font-bold mb-4">Datos</h2>
      
      <div class="space-y-4">
        <div class="flex justify-between items-center">
          <div>
            <h3 class="font-semibold">Archivar datos de usuarios</h3>
            <p class="text-gray-400 text-sm">Ver resumen de usuarios y estad√≠sticas</p>
          </div>
          <button onclick="window.location.href='archivo-datos.html'" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg text-sm w-24">
            Ver archivo
          </button>
        </div>
        <div class="flex justify-between items-center">
          <div>
            <h3 class="font-semibold">Limpiar datos</h3>
            <p class="text-gray-400 text-sm">Eliminar todos los datos</p>
          </div>
          <button onclick="clearAllData()" class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded-lg text-sm w-24">
            Limpiar
          </button>
        </div>
        <div class="flex justify-between items-center">
          <div>
            <h3 class="font-semibold">Limpiar pagos</h3>
            <p class="text-gray-400 text-sm">Limpiar informaci√≥n de pagos de todas las personas</p>
          </div>
          <button onclick="clearPaymentData()" class="bg-orange-600 hover:bg-orange-700 px-4 py-2 rounded-lg text-sm w-24">
            Limpiar
          </button>
        </div>
      </div>
    </div>

    <!-- Secci√≥n de Informaci√≥n -->
    <div class="bg-[#1B1930] rounded-xl p-6 mb-6">
      <h2 class="text-xl font-bold mb-4">Informaci√≥n</h2>
      
      <div class="space-y-4">
        <div class="flex justify-between items-center">
          <div>
            <h3 class="font-semibold">A√±o actual</h3>
            <p class="text-gray-400 text-sm">A√±o para el calendario</p>
          </div>
          <div class="flex items-center space-x-2">
            <select id="yearSelector" class="bg-[#3f3f46] rounded-md px-3 py-1 text-white text-sm border-none focus:outline-none">
              <!-- Las opciones se generar√°n din√°micamente -->
            </select>
            <button onclick="saveYear()" class="bg-green-600 hover:bg-green-700 px-3 py-1 rounded-md text-sm">
              Guardar
            </button>
          </div>
        </div>
        
        <div class="flex justify-between items-center">
          <div>
            <h3 class="font-semibold">Versi√≥n</h3>
            <p class="text-gray-400 text-sm">App Suscripciones</p>
          </div>
          <span id="versionNumber" class="text-gray-400 font-semibold">1.0.55</span>
        </div>
        
        <div class="flex justify-between items-center">
          <div>
            <h3 class="font-semibold">Suscripciones</h3>
            <p class="text-gray-400 text-sm">Total de suscripciones</p>
          </div>
          <span id="totalSubscriptions" class="text-gray-400">0</span>
        </div>
        
        <div class="flex justify-between items-center">
          <div>
            <h3 class="font-semibold">Personas</h3>
            <p class="text-gray-400 text-sm">Total de personas</p>
          </div>
          <span id="totalPersonas" class="text-gray-400">0</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Bottom Navigation -->
  <nav class="fixed bottom-0 left-0 right-0 bg-[#1B1930]/80 backdrop-blur-md flex justify-between items-center px-16 py-4 border-t border-white/10 text-white/50 text-xs z-50">
    <button class="flex flex-col items-center space-y-1" onclick="navigateTo('index.html')">
      <i class="fas fa-moon text-lg"></i>
      <span class="select-none">Subscriptions</span>
    </button>
    <button class="flex flex-col items-center space-y-1" onclick="navigateTo('calendar.html')">
      <i class="fas fa-th-large text-xl"></i>
      <span class="select-none">Calendar</span>
    </button>
    <button class="flex flex-col items-center space-y-1" onclick="navigateTo('personas.html')">
      <i class="fas fa-users text-lg"></i>
      <span class="select-none">Personas</span>
    </button>
    <button class="flex flex-col items-center space-y-1 text-white" onclick="navigateTo('settings.html')">
      <i class="fas fa-cog text-lg"></i>
      <span class="select-none">Settings</span>
    </button>
  </nav>
  
  <script>
    // Funci√≥n de navegaci√≥n optimizada (sin bloqueos)
    function navigateTo(page) {
      // Prevenir m√∫ltiples clics
      if (window.navigating) {
        return;
      }
      window.navigating = true;
      
      // Navegar inmediatamente sin esperar
      try {
        // Usar replace para evitar acumulaci√≥n en el historial
        window.location.replace(page);
      } catch (e) {
        console.error('Error al navegar:', e);
        // Fallback
        try {
          window.location.href = page;
        } catch (e2) {
          window.location.assign(page);
        }
      }
    }
  </script>
</body>
</html> 
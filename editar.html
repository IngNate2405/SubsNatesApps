<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <script>if (location.protocol === 'http:' && location.hostname !== 'localhost' && !location.hostname.match(/^127\./)) { location.replace('https://' + location.host + location.pathname + location.search); }</script>
  <meta content="width=device-width, initial-scale=1" name="viewport"/>
  <title>Editar Suscripción - App Suscripciones</title>
  <meta name="description" content="Editar suscripción">
  <meta name="theme-color" content="#1B1930">
  <link rel="manifest" href="./manifest.json">
  <link rel="apple-touch-icon" href="./icons/icon-192x192.png">
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet"/>
  
  <!-- Scripts de Firebase (para cargar iconos guardados) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="firebase-config.js"></script>
  <script src="firebase-service.js"></script>
  <script src="onesignal-config.js"></script>
  <!-- Cargar configuración local si existe (NO se sube a GitHub) -->
  <script src="onesignal-config-local.js" onerror="console.log('onesignal-config-local.js no encontrado (esto es normal)')"></script>
  <script src="onesignal-service.js"></script>
  <script src="onesignal-session.js"></script>
  <script src="version.js"></script>
  <!-- OneSignal SDK (debe cargar antes que onesignal-notifications.js) -->
  <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js"></script>
  <script src="onesignal-notifications.js"></script>
  <style>
    body, html {
      overflow-x: hidden !important;
      overscroll-behavior-x: none;
      max-width: 100vw;
      box-sizing: border-box;
    }
    /* Ocultar scrollbars en móvil */
    body::-webkit-scrollbar, html::-webkit-scrollbar {
      display: none;
    }
    body {
      -ms-overflow-style: none;
      scrollbar-width: none;
    }
    /* Custom toggle switch */
    input[type="checkbox"] {
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
      width: 2.5rem;
      height: 1.25rem;
      background-color: #3f3f46;
      border-radius: 9999px;
      position: relative;
      cursor: pointer;
      outline: none;
      transition: background-color 0.2s ease-in-out;
    }
    input[type="checkbox"]:checked {
      background-color: #fff;
    }
    input[type="checkbox"]::before {
      content: "";
      position: absolute;
      top: 0.125rem;
      left: 0.125rem;
      width: 1rem;
      height: 1rem;
      background-color: white;
      border-radius: 9999px;
      transition: transform 0.2s ease-in-out;
      box-shadow: 0 0 2px rgb(0 0 0 / 0.2);
    }
    input[type="checkbox"]:checked::before {
      transform: translateX(1.25rem);
      background-color: #000;
    }
    body {
      font-family: 'Inter', sans-serif;
    }
    /* Estilo para inputs de fecha */
    input[type="date"] {
      position: relative;
      color: white;
    }
    input[type="date"]::-webkit-calendar-picker-indicator {
      position: absolute;
      right: 0;
      top: 50%;
      transform: translateY(-50%);
      width: 20px;
      height: 20px;
      margin: 0;
      padding: 0;
      cursor: pointer;
      opacity: 1;
      filter: invert(1);
    }
    /* Quitar los spinners de los inputs numéricos */
    input[type="number"]::-webkit-inner-spin-button,
    input[type="number"]::-webkit-outer-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    input[type="number"] {
      -moz-appearance: textfield;
    }
  </style>
  <script>
    // Función para obtener el ID de la suscripción de la URL
    function getSubscriptionId() {
      const params = new URLSearchParams(window.location.search);
      return params.get('id');
    }

    // Función para formatear como moneda
    function formatCurrency(value) {
      const number = value.replace(/[^0-9]/g, '');
      return `Q${number}.00`;
    }

    // Función para formatear la fecha como dd/mm/yyyy
    function formatDate(dateString) {
      const date = new Date(dateString);
      const day = String(date.getDate()).padStart(2, '0');
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const year = date.getFullYear();
      return `${day}/${month}/${year}`;
    }

    // Función para formatear la hora como HH:mm
    function formatTime(date) {
      const hours = String(date.getHours()).padStart(2, '0');
      const minutes = String(date.getMinutes()).padStart(2, '0');
      return `${hours}:${minutes}`;
    }

    // Función para convertir fecha dd/mm/yyyy a formato ISO
    function parseDate(dateString) {
      const [day, month, year] = dateString.split('/');
      return `${year}-${month}-${day}`;
    }

    // Función para formatear la fecha para el input type="date" (yyyy-MM-dd)
    function formatDateForInput(dateString) {
      const date = new Date(dateString);
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`; // Formato yyyy-MM-dd
    }

    // Función para mostrar la fecha en formato dd-MM-yyyy
    function displayDate(dateString) {
      const date = new Date(dateString);
      const day = String(date.getDate()).padStart(2, '0');
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const year = date.getFullYear();
      return `${day}-${month}-${year}`;
    }

    // Función para calcular la conversión y ganancia
    function calculatePrices() {
      const originalPriceUSD = parseFloat(document.querySelector('input[name="original_price_usd"]').value) || 0;
      const debitPriceGTQ = parseFloat(document.querySelector('input[name="debit_price_gtq"]').value) || 0;
      const billing = document.querySelector('select[name="billing"]').value;
      const nombreSuscripcion = document.querySelector('input[name="name"]').value;
      
      // Calcular conversión (USD a GTQ)
      const conversionRate = 8;
      const convertedPrice = originalPriceUSD * conversionRate;
      document.getElementById('conversion_display').textContent = convertedPrice.toFixed(2);
      
      // Obtener todas las personas y sus suscripciones
      const personas = JSON.parse(localStorage.getItem('personas') || '[]');
      let totalCobro = 0;

      // Calcular el total de cobro basado en los pagos de las personas
      personas.forEach(persona => {
        persona.plataformas.forEach(plataforma => {
          if (plataforma.nombre === nombreSuscripcion) {
            let pago = parseFloat(plataforma.precio) || 0;
            let cicloPersona = plataforma.tipoCobro || 'mensual';
            let cicloSuscripcion = billing || 'mensual';
            let factor = 1;
            if (cicloPersona === cicloSuscripcion) {
              factor = 1;
            } else if (cicloPersona === 'mensual' && cicloSuscripcion === 'semestral') {
              factor = 6;
            } else if (cicloPersona === 'mensual' && cicloSuscripcion === 'anual') {
              factor = 12;
            } else if (cicloPersona === 'semestral' && cicloSuscripcion === 'mensual') {
              factor = 1/6;
            } else if (cicloPersona === 'anual' && cicloSuscripcion === 'mensual') {
              factor = 1/12;
            } else if (cicloPersona === 'semestral' && cicloSuscripcion === 'anual') {
              factor = 2;
            } else if (cicloPersona === 'anual' && cicloSuscripcion === 'semestral') {
              factor = 0.5;
            } else if (cicloPersona === 'trimestral' && cicloSuscripcion === 'mensual') {
              factor = 1/3;
            } else if (cicloPersona === 'mensual' && cicloSuscripcion === 'trimestral') {
              factor = 3;
            } else if (cicloPersona === 'trimestral' && cicloSuscripcion === 'semestral') {
              factor = 2;
            } else if (cicloPersona === 'semestral' && cicloSuscripcion === 'trimestral') {
              factor = 0.5;
            } else if (cicloPersona === 'trimestral' && cicloSuscripcion === 'anual') {
              factor = 4;
            } else if (cicloPersona === 'anual' && cicloSuscripcion === 'trimestral') {
              factor = 0.25;
            }
            totalCobro += pago * factor;
          }
        });
      });

      // Actualizar el precio de cobro
      document.getElementById('charge_price_display').textContent = totalCobro.toFixed(2);
      
      // Calcular ganancia
      let profit = 0;
      if (totalCobro > 0) {
        profit = totalCobro - debitPriceGTQ;
      } else {
        profit = convertedPrice - debitPriceGTQ;
      }
      document.getElementById('profit_display').textContent = profit.toFixed(2);
    }

    // Obtener tipos de notificación desde Configuración → Notificaciones (preferencias globales)
    function getNotificationPreferencesFromConfig() {
      try {
        const raw = localStorage.getItem('notification_preferences');
        if (!raw) return [];
        const prefs = JSON.parse(raw);
        return Array.isArray(prefs.types) ? prefs.types : [];
      } catch (e) { return []; }
    }

    // Función para cargar los datos de la suscripción
    function loadSubscriptionData() {
      const params = new URLSearchParams(window.location.search);
      const isNew = params.get('new') === 'true';
      const subscriptionId = params.get('id');

      if (!isNew && !subscriptionId) {
        window.location.href = 'index.html';
        return;
      }

      if (isNew) {
        // Mostrar logo genérico para nueva suscripción
        document.getElementById('subscription-logo').src = 'https://upload.wikimedia.org/wikipedia/commons/thumb/9/9c/Generic_Placeholder.svg/1920px-Generic_Placeholder.svg.png';
        // Limpiar todos los campos para una nueva suscripción
        document.querySelector('input[name="name"]').value = '';
        document.querySelector('select[name="billing"]').value = 'mensual';
        
        // Cambiar el título para nueva suscripción
        document.getElementById('pageTitle').textContent = 'Nueva Suscripción';
        
        // Establecer la fecha actual como primer pago
        const today = new Date();
        document.querySelector('input[name="nextPayment"]').value = today.toISOString().split('T')[0];
        
        document.querySelector('input[name="category"]').value = 'Streaming';
        document.querySelector('select[name="list"]').value = 'personal';
        
        // Limpiar campos de precio
        document.querySelector('input[name="original_price_usd"]').value = '';
        document.querySelector('input[name="debit_price_gtq"]').value = '';
        // No limpiar charge_price_gtq porque no existe como input, solo como display
        document.getElementById('conversion_display').textContent = '0.00';
        document.getElementById('charge_price_display').textContent = '0.00';
        document.getElementById('profit_display').textContent = '0.00';
        return;
      }

      const subscriptions = JSON.parse(localStorage.getItem('subscriptions') || '[]');
      const subscription = subscriptions.find(sub => sub.id === subscriptionId);
      if (subscription) {
        // Cargar el logo si existe
        if (subscription.logo && subscription.logo !== 'https://upload.wikimedia.org/wikipedia/commons/thumb/9/9c/Generic_Placeholder.svg/1920px-Generic_Placeholder.svg.png') {
          document.getElementById('subscription-logo').src = subscription.logo;
          document.getElementById('delete-logo-btn').style.display = 'block';
        } else {
          document.getElementById('delete-logo-btn').style.display = 'none';
        }
        // Cargar campos básicos
        const nameInput = document.querySelector('input[name="name"]');
        const apodoInput = document.querySelector('input[name="apodo"]');
        const billingSelect = document.querySelector('select[name="billing"]');
        const nextPaymentInput = document.querySelector('input[name="nextPayment"]');
        const categoryInput = document.querySelector('input[name="category"]');
        const listSelect = document.querySelector('select[name="list"]');

        if (nameInput) nameInput.value = subscription.name || '';
        if (apodoInput) apodoInput.value = subscription.apodo || '';
        if (billingSelect) billingSelect.value = subscription.billing || 'mensual';
        if (nextPaymentInput) {
          const nextPaymentDate = new Date(subscription.nextPayment);
          nextPaymentInput.value = nextPaymentDate.toISOString().split('T')[0];
        }
        if (categoryInput) categoryInput.value = subscription.category || '';
        if (listSelect) {
          listSelect.value = subscription.list || 'personal';
          console.log('Tipo de suscripción cargado:', subscription.list);
          // Si es compartida, mostrar la sección y cargar el número de perfiles
          if (subscription.list === 'compartido') {
            console.log('Es suscripción compartida, buscando sección...');
            const seccionCompartida = document.getElementById('seccion-compartida');
            console.log('Elemento seccion-compartida encontrado:', !!seccionCompartida);
            if (seccionCompartida) {
              seccionCompartida.classList.remove('hidden');
              // Forzar remoción de la clase hidden por si algún otro código la vuelve a agregar
              setTimeout(() => {
                seccionCompartida.classList.remove('hidden');
                console.log('Clase hidden forzada a removerse de seccion-compartida');
              }, 100);
              console.log('Clase hidden removida de seccion-compartida');
            } else {
              console.error('No se encontró el elemento seccion-compartida');
            }
            const perfilesInput = document.getElementById('perfiles-input');
            console.log('Elemento perfiles-input encontrado:', !!perfilesInput);
            if (perfilesInput) {
              perfilesInput.value = subscription.numPerfiles || '';
              console.log('Número de perfiles cargado:', subscription.numPerfiles);
              if (subscription.numPerfiles) {
                // Generar los iconos después de establecer el valor
                console.log('Generando iconos para', subscription.numPerfiles, 'perfiles');
                generarIconosPerfiles(subscription.numPerfiles);
                // Actualizar el estado de los perfiles
                actualizarPerfiles();
              }
            } else {
              console.error('No se encontró el elemento perfiles-input');
            }
          } else {
            console.log('No es suscripción compartida, tipo:', subscription.list);
          }
          
          // Disparar el evento change para activar los event listeners
          // listSelect.dispatchEvent(new Event('change'));
        }
        
        // Verificar si es una prueba gratuita
        if (subscription.free_trial) {
          const freeTrialCheckbox = document.querySelector('input[name="free_trial"]');
          if (freeTrialCheckbox) {
            freeTrialCheckbox.checked = true;
            // Disparar el evento change para configurar la interfaz
            freeTrialCheckbox.dispatchEvent(new Event('change'));
          }
          
          // Cargar fecha de fin de prueba
          const trialEndDateInput = document.querySelector('input[name="trial_end_date"]');
          if (trialEndDateInput && subscription.trial_end_date) {
            const trialEndDate = new Date(subscription.trial_end_date);
            trialEndDateInput.value = trialEndDate.toISOString().split('T')[0];
          }
        }
        
        // Cargar campos de precio solo si no es prueba gratuita
        if (!subscription.free_trial) {
          const originalPriceUSDInput = document.querySelector('input[name="original_price_usd"]');
          const debitPriceGTQInput = document.querySelector('input[name="debit_price_gtq"]');
          // charge_price_gtq no existe como input, solo como display

          if (originalPriceUSDInput) originalPriceUSDInput.value = subscription.original_price_usd || '';
          if (debitPriceGTQInput) debitPriceGTQInput.value = subscription.debit_price_gtq || '';
          // El charge_price_display se actualiza automáticamente con calculatePrices()
          
          // Calcular precios
          calculatePrices();
        }

      }
    }

    // Función para guardar los cambios
    async function handleSave() {
      console.log('Función handleSave iniciada');
      const params = new URLSearchParams(window.location.search);
      const isNew = params.get('new') === 'true';
      const subscriptionId = params.get('id');

      console.log('Parámetros:', { isNew, subscriptionId });

      // Obtener las suscripciones existentes al inicio de la función
      const subscriptions = JSON.parse(localStorage.getItem('subscriptions') || '[]');

      // Obtener los elementos del DOM
      const nameInput = document.querySelector('input[name="name"]');
      const apodoInput = document.querySelector('input[name="apodo"]');
      const nextPaymentInput = document.querySelector('input[name="nextPayment"]');
      const billingSelect = document.querySelector('select[name="billing"]');
      const categoryInput = document.querySelector('input[name="category"]');
      const listSelect = document.querySelector('select[name="list"]');
      const originalPriceUSDInput = document.querySelector('input[name="original_price_usd"]');
      const debitPriceGTQInput = document.querySelector('input[name="debit_price_gtq"]');
      const chargePriceDisplay = document.getElementById('charge_price_display');
      const profitDisplay = document.getElementById('profit_display');

      console.log('Elementos del DOM encontrados:', {
        nameInput: !!nameInput,
        nextPaymentInput: !!nextPaymentInput,
        billingSelect: !!billingSelect,
        categoryInput: !!categoryInput,
        listSelect: !!listSelect,
        originalPriceUSDInput: !!originalPriceUSDInput,
        debitPriceGTQInput: !!debitPriceGTQInput,
        chargePriceDisplay: !!chargePriceDisplay,
        profitDisplay: !!profitDisplay
      });

      // Validar que todos los elementos existan
      if (!nameInput || !nextPaymentInput || !billingSelect || !categoryInput || !listSelect || 
          !originalPriceUSDInput || !debitPriceGTQInput || !chargePriceDisplay || !profitDisplay) {
        alert('Error: No se pudieron encontrar todos los elementos del formulario');
        return;
      }

      // Obtener los valores de los campos
      const name = nameInput.value;
      const apodo = apodoInput ? apodoInput.value.trim() : '';
      const nextPaymentDate = nextPaymentInput.value;
      const nextPayment = new Date(nextPaymentDate + 'T00:00:00');
      const billing = billingSelect.value;
      const category = categoryInput.value;
      const list = listSelect.value;
      const originalPriceUSD = originalPriceUSDInput.value;
      const debitPriceGTQ = debitPriceGTQInput.value;
      const chargePriceGTQ = chargePriceDisplay.textContent;
      const ganancia = profitDisplay.textContent;

      // Verificar si es prueba gratuita
      const freeTrialCheckbox = document.querySelector('input[name="free_trial"]');
      const isFreeTrial = freeTrialCheckbox && freeTrialCheckbox.checked;

      console.log('Valores obtenidos:', {
        name,
        nextPaymentDate,
        billing,
        category,
        list,
        originalPriceUSD,
        debitPriceGTQ,
        chargePriceGTQ,
        ganancia,
        isFreeTrial
      });

      // Validar campos requeridos según el tipo
      let validationError = false;
      let missingFields = [];

      if (!name) {
        validationError = true;
        missingFields.push('nombre');
      }

      if (isFreeTrial) {
        // Para prueba gratuita, solo validar nombre y precio de prueba
        const trialEndDateInput = document.querySelector('input[name="trial_end_date"]');
        const trialEndDate = trialEndDateInput ? trialEndDateInput.value : '';
        
        if (!trialEndDate) {
          validationError = true;
          missingFields.push('fecha de fin de prueba');
        }
        
        console.log('Validación de prueba gratuita:', { trialEndDate });
      } else {
        // Para suscripción normal, validar todos los campos
        if (!originalPriceUSD) {
          validationError = true;
          missingFields.push('precio original USD');
        }
        if (!debitPriceGTQ) {
          validationError = true;
          missingFields.push('precio debitado GTQ');
        }
        if (!nextPaymentDate) {
          validationError = true;
          missingFields.push('fecha de próximo pago');
        }
        if (!billing) {
          validationError = true;
          missingFields.push('ciclo de facturación');
        }
      }

      if (validationError) {
        console.log('Validación fallida - campos faltantes:', missingFields);
        alert(`Por favor complete todos los campos requeridos: ${missingFields.join(', ')}`);
        return;
      }

      console.log('Validación de campos exitosa');

      // Notificaciones: se usan las preferencias globales de Configuración → Notificaciones
      const notifications = getNotificationPreferencesFromConfig();
      console.log('Notificaciones (desde Configuración):', notifications);

      // Crear objeto base de suscripción
      const subscriptionData = {
        name,
        apodo: apodo || name, // Si no hay apodo, usar el nombre
        logo: window.logoData || document.getElementById('subscription-logo')?.src || 'https://upload.wikimedia.org/wikipedia/commons/thumb/9/9c/Generic_Placeholder.svg/1920px-Generic_Placeholder.svg.png',
        status: isNew ? 'active' : (subscriptions.find(sub => sub.id === subscriptionId)?.status || 'active')
      };

      if (isFreeTrial) {
        // Para prueba gratuita
        const trialEndDateInput = document.querySelector('input[name="trial_end_date"]');
        const trialEndDate = trialEndDateInput ? new Date(trialEndDateInput.value + 'T00:00:00') : new Date();
        
        subscriptionData.free_trial = true;
        subscriptionData.trial_end_date = trialEndDate.toISOString();
        subscriptionData.billing = 'trial';
        subscriptionData.nextPayment = trialEndDate.toISOString();
        subscriptionData.category = category || 'Prueba gratuita';
        subscriptionData.list = list; // Usar el valor del select (puede ser "prueba_gratuita", "personal", etc.)
        subscriptionData.notifications = notifications;
        subscriptionData.original_price_usd = '0.00';
        subscriptionData.debit_price_gtq = '0.00';
        subscriptionData.charge_price_gtq = '0.00';
        subscriptionData.ganancia = '0.00';
        
        console.log('Configuración de prueba gratuita:', subscriptionData);
      } else {
        // Para suscripción normal
        subscriptionData.billing = billing;
        subscriptionData.nextPayment = nextPayment.toISOString();
        subscriptionData.category = category;
        subscriptionData.list = list;
        subscriptionData.notifications = notifications;
        subscriptionData.original_price_usd = originalPriceUSD;
        subscriptionData.debit_price_gtq = debitPriceGTQ;
        subscriptionData.charge_price_gtq = chargePriceGTQ;
        subscriptionData.ganancia = ganancia;
        subscriptionData.free_trial = false;
        
        console.log('Configuración de suscripción normal:', subscriptionData);
      }

      console.log('Objeto subscriptionData creado:', subscriptionData);

      // Agregar número de perfiles si es una suscripción compartida
      if (!isFreeTrial && list === 'compartido') {
        const perfilesInput = document.getElementById('perfiles-input');
        if (perfilesInput && perfilesInput.value) {
          subscriptionData.numPerfiles = parseInt(perfilesInput.value);
        }
      }

      if (isNew) {
        subscriptionData.id = Date.now().toString();
        subscriptions.push(subscriptionData);
        console.log('Nueva suscripción agregada al array');
        console.log('Array de suscripciones antes de guardar:', subscriptions);
        localStorage.setItem('subscriptions', JSON.stringify(subscriptions));
        console.log('Guardado en localStorage:', localStorage.getItem('subscriptions'));
      } else {
        const index = subscriptions.findIndex(sub => sub.id === subscriptionId);
        if (index === -1) {
          alert('Error: No se encontró la suscripción');
          return;
        }
        subscriptions[index] = { ...subscriptions[index], ...subscriptionData };
        console.log('Suscripción existente actualizada en el array');
        console.log('Array de suscripciones antes de guardar:', subscriptions);
        localStorage.setItem('subscriptions', JSON.stringify(subscriptions));
        console.log('Guardado en localStorage:', localStorage.getItem('subscriptions'));
      }

      // Enviar recordatorios a OneSignal (solo esta suscripción, directo a la API)
      let notifResult = { sent: 0, failed: 0, error: null };
      if (typeof OneSignalNotifications !== 'undefined' && subscriptionData.notifications && subscriptionData.notifications.length > 0 && subscriptionData.nextPayment) {
        try {
          notifResult = await OneSignalNotifications.scheduleRemindersForSubscription(subscriptionData);
        } catch (err) {
          notifResult.error = err.message || String(err);
          console.error('Error OneSignal:', err);
        }
      }

      if (notifResult.sent > 0) {
        alert((isNew ? 'Suscripción creada. ' : 'Suscripción actualizada. ') + notifResult.sent + ' recordatorio(s) enviados a OneSignal. Te llegarán al teléfono a la hora programada.');
      } else if (notifResult.error) {
        alert((isNew ? 'Suscripción creada. ' : 'Suscripción actualizada. ') + '\n\nRecordatorios no enviados: ' + notifResult.error);
      } else {
        alert(isNew ? 'Suscripción creada' : 'Suscripción actualizada');
      }
      window.location.href = 'index.html';
    }

    // Función para generar los iconos de perfiles
    function generarIconosPerfiles(numeroPerfiles) {
      const container = document.getElementById('perfiles-container');
      if (!container) return;
      container.innerHTML = ''; // Limpiar contenedor
      // Obtener todas las personas y sus suscripciones
      const personas = JSON.parse(localStorage.getItem('personas') || '[]');
      const nombreSuscripcion = document.querySelector('input[name="name"]').value;
      // Crear un array de nombres de personas que tienen esta suscripción (pueden repetirse)
      const perfilesOcupados = [];
      personas.forEach(persona => {
        if (persona.plataformas && Array.isArray(persona.plataformas)) {
          persona.plataformas.forEach(plataforma => {
            if (plataforma.nombre.toLowerCase() === nombreSuscripcion.toLowerCase()) {
              perfilesOcupados.push(persona.nombre);
            }
          });
        }
      });
      for (let i = 0; i < numeroPerfiles; i++) {
        const icono = document.createElement('div');
        icono.className = 'perfil-icono text-2xl relative group cursor-pointer';
        const estaOcupado = i < perfilesOcupados.length;
        const nombrePersona = perfilesOcupados[i] || '';
        icono.classList.add(estaOcupado ? 'text-red-500' : 'text-green-500');
        icono.innerHTML = '<i class="fas fa-user"></i>';
        const tooltip = document.createElement('div');
        tooltip.className = 'absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-2 py-1 bg-[#1f1c2b] text-white text-sm rounded opacity-0 transition-opacity whitespace-nowrap z-50';
        tooltip.textContent = estaOcupado ? nombrePersona : 'Disponible';
        let tooltipVisible = false;
        icono.addEventListener('click', function() {
          tooltipVisible = !tooltipVisible;
          if (tooltipVisible) {
            tooltip.classList.remove('opacity-0');
          } else {
            tooltip.classList.add('opacity-0');
          }
        });
        icono.addEventListener('mouseenter', function() {
          if (!tooltipVisible) {
            tooltip.classList.remove('opacity-0');
          }
        });
        icono.addEventListener('mouseleave', function() {
          if (!tooltipVisible) {
            tooltip.classList.add('opacity-0');
          }
        });
        icono.appendChild(tooltip);
        container.appendChild(icono);
      }
    }

    // Función para actualizar los perfiles
    function actualizarPerfiles() {
      const perfilesInput = document.getElementById('perfiles-input');
      if (perfilesInput && perfilesInput.value) {
        generarIconosPerfiles(parseInt(perfilesInput.value));
      }
    }

    // Función para cargar versión
    function cargarVersion() {
      const versionElement = document.getElementById('app-version');
      if (!versionElement) return;
      
      const versionHTML = '1.0.52'; // Versión base del código
      const savedVersion = localStorage.getItem('appVersion');
      
      // Si hay una versión guardada y es mayor, usarla
      if (savedVersion && savedVersion > versionHTML) {
        versionElement.textContent = `v${savedVersion}`;
      } else {
        versionElement.textContent = `v${versionHTML}`;
        localStorage.setItem('appVersion', versionHTML);
      }
    }

    // Agregar eventos cuando el DOM esté cargado
    document.addEventListener('DOMContentLoaded', () => {
      cargarVersion();
      loadSubscriptionData();

      // Inicializar OneSignal en esta página para que al guardar tengamos Player ID y se envíen los recordatorios
      if (typeof window.oneSignalSession !== 'undefined' && typeof ONESIGNAL_CONFIG !== 'undefined' && ONESIGNAL_CONFIG.appId) {
        window.oneSignalSession.initializeOnce(ONESIGNAL_CONFIG.appId, ONESIGNAL_CONFIG.safariWebId).then(() => {
          console.log('✅ OneSignal listo en página de edición (recordatorios se enviarán al guardar)');
        }).catch(() => {});
      }

      // Botón de guardar
      const saveButton = document.getElementById('saveButton');
      if (saveButton) {
        console.log('Botón de guardar encontrado, agregando event listener');
        saveButton.addEventListener('click', () => {
          console.log('Botón de guardar clickeado');
          handleSave();
        });
      } else {
        console.error('Botón de guardar no encontrado');
      }

      // Manejar la visibilidad de la sección de prueba gratuita
      const freeTrialCheckbox = document.querySelector('input[name="free_trial"]');
      const freeTrialSection = document.getElementById('freeTrialSection');
      const regularSubscriptionSection = document.getElementById('regularSubscriptionSection');
      const sharedSubscriptionSection = document.getElementById('seccion-compartida');
      
      // Función para encontrar las secciones de manera compatible
      function findSections() {
        const sections = document.querySelectorAll('section');
        let typeSection = null;
        let pricesSection = null;
        
        sections.forEach(section => {
          if (section.querySelector('select[name="list"]')) {
            typeSection = section;
          }
          if (section.querySelector('input[name="original_price_usd"]')) {
            pricesSection = section;
          }
        });
        
        return { typeSection, pricesSection };
      }
      
      const { typeSection, pricesSection } = findSections();
      
      if (freeTrialCheckbox && freeTrialSection && regularSubscriptionSection) {
        freeTrialCheckbox.addEventListener('change', function() {
          if (this.checked) {
            freeTrialSection.classList.remove('hidden');
            regularSubscriptionSection.classList.add('hidden');
            if (typeSection) typeSection.classList.remove('hidden');
            if (sharedSubscriptionSection) sharedSubscriptionSection.classList.add('hidden');
            if (pricesSection) pricesSection.classList.add('hidden');
            
            const tipoSelect = document.querySelector('select[name="list"]');
            if (tipoSelect) tipoSelect.value = 'prueba_gratuita';
          } else {
            freeTrialSection.classList.add('hidden');
            regularSubscriptionSection.classList.remove('hidden');
            if (typeSection) typeSection.classList.remove('hidden');
            if (sharedSubscriptionSection) sharedSubscriptionSection.classList.add('hidden');
            if (pricesSection) pricesSection.classList.remove('hidden');
          }
        });
      }

      // Verificar estado inicial
      if (freeTrialCheckbox.checked) {
        freeTrialSection.classList.remove('hidden');
        regularSubscriptionSection.classList.add('hidden');
        if (typeSection) typeSection.classList.remove('hidden');
        if (sharedSubscriptionSection) sharedSubscriptionSection.classList.add('hidden');
        if (pricesSection) pricesSection.classList.add('hidden');
        
        const tipoSelect = document.querySelector('select[name="list"]');
        if (tipoSelect) tipoSelect.value = 'prueba_gratuita';
      } else {
        freeTrialSection.classList.add('hidden');
        regularSubscriptionSection.classList.remove('hidden');
        if (typeSection) typeSection.classList.remove('hidden');
        if (sharedSubscriptionSection) sharedSubscriptionSection.classList.add('hidden');
        if (pricesSection) pricesSection.classList.remove('hidden');
      }

      // Agregar event listeners para los campos de precio
      const originalPriceUSDInput = document.querySelector('input[name="original_price_usd"]');
      const debitPriceGTQInput = document.querySelector('input[name="debit_price_gtq"]');

      if (originalPriceUSDInput) {
        originalPriceUSDInput.addEventListener('input', calculatePrices);
        originalPriceUSDInput.addEventListener('change', calculatePrices);
      }

      if (debitPriceGTQInput) {
        debitPriceGTQInput.addEventListener('input', calculatePrices);
        debitPriceGTQInput.addEventListener('change', calculatePrices);
      }

      // Calcular precios iniciales
      calculatePrices();

      // Deshabilitar las teclas de flecha en inputs numéricos
      const numberInputs = document.querySelectorAll('input[type="number"]');
      numberInputs.forEach(input => {
        input.addEventListener('keydown', (e) => {
          if (e.key === 'ArrowUp' || e.key === 'ArrowDown') {
            e.preventDefault();
          }
        });
      });

      // Manejar el cambio de tipo de suscripción
      document.addEventListener('click', function(e) {
        if (e.target.classList.contains('tipo-btn')) {
          // Actualizar botones de tipo
          const buttons = e.target.parentElement.querySelectorAll('.tipo-btn');
          buttons.forEach(btn => {
            btn.classList.remove('bg-[#3f2a6f]');
            btn.classList.add('bg-[#2a2736]');
          });
          e.target.classList.remove('bg-[#2a2736]');
          e.target.classList.add('bg-[#3f2a6f]');

          // Mostrar/ocultar sección de suscripción compartida
          const seccionCompartida = document.getElementById('seccion-compartida');
          if (e.target.dataset.tipo === 'compartida') {
            seccionCompartida.classList.remove('hidden');
            actualizarPerfiles();
          } else {
            seccionCompartida.classList.add('hidden');
          }
        }
      });

      // Modificar el event listener para el select de tipo de suscripción
      document.querySelector('select[name="list"]').addEventListener('change', function(e) {
        const seccionCompartida = document.getElementById('seccion-compartida');
        if (e.target.value === 'compartido') {
          seccionCompartida.classList.remove('hidden');
          actualizarPerfiles();
        } else {
          // Solo ocultar si no es una suscripción compartida existente
          const subscriptionId = getSubscriptionId();
          if (subscriptionId) {
            const subscriptions = JSON.parse(localStorage.getItem('subscriptions') || '[]');
            const subscription = subscriptions.find(sub => sub.id === subscriptionId);
            if (subscription && subscription.list === 'compartido') {
              // Es una suscripción compartida existente, no ocultar
              return;
            }
          }
          seccionCompartida.classList.add('hidden');
        }
      });

      // Evento para el input de perfiles
      const perfilesInput = document.getElementById('perfiles-input');
      if (perfilesInput) {
        perfilesInput.addEventListener('input', function(e) {
          const numeroPerfiles = parseInt(e.target.value) || 0;
          if (numeroPerfiles >= 1 && numeroPerfiles <= 7) {
            generarIconosPerfiles(numeroPerfiles);
          } else {
            document.getElementById('perfiles-container').innerHTML = '';
          }
        });
      }

      // Evento para cuando cambia el nombre de la suscripción
      const nombreInput = document.querySelector('input[name="name"]');
      if (nombreInput) {
        nombreInput.addEventListener('input', function() {
          const seccionCompartida = document.getElementById('seccion-compartida');
          if (!seccionCompartida.classList.contains('hidden')) {
            actualizarPerfiles();
          }
        });
      }

      // Evento para el cambio de tipo de suscripción
      document.querySelector('select[name="list"]').addEventListener('change', function(e) {
        const seccionCompartida = document.getElementById('seccion-compartida');
        if (e.target.value === 'compartido') {
          seccionCompartida.classList.remove('hidden');
          actualizarPerfiles();
        } else {
          // Solo ocultar si no es una suscripción compartida existente
          const subscriptionId = getSubscriptionId();
          if (subscriptionId) {
            const subscriptions = JSON.parse(localStorage.getItem('subscriptions') || '[]');
            const subscription = subscriptions.find(sub => sub.id === subscriptionId);
            if (subscription && subscription.list === 'compartido') {
              // Es una suscripción compartida existente, no ocultar
              return;
            }
          }
          seccionCompartida.classList.add('hidden');
        }
      });
    });

    // Función para mostrar el selector de iconos
    async function mostrarSelectorIconos() {
      const modal = document.getElementById('iconos-modal');
      const lista = document.getElementById('iconos-lista');
      const noIconos = document.getElementById('no-iconos-message');
      
      modal.classList.remove('hidden');
      lista.innerHTML = '<div class="col-span-3 text-center text-gray-400">Cargando...</div>';
      
      try {
        let iconos = [];
        
        // Intentar cargar desde Firebase si está disponible
        if (isFirebaseAvailable && isFirebaseAvailable()) {
          let user = firebaseService.getCurrentUser();
          if (!user && typeof auth !== 'undefined' && auth) {
            user = auth.currentUser;
          }
          
          if (user) {
            try {
              const iconosRef = db.collection('users').doc(user.uid).collection('subscription_icons');
              const snapshot = await iconosRef.get();
              iconos = snapshot.docs.map(doc => ({
                id: doc.id,
                nombre: doc.data().nombre,
                url: doc.data().url,
                esBase64: doc.data().esBase64 || false
              }));
            } catch (error) {
              console.error('Error al cargar iconos de Firebase:', error);
            }
          }
        }
        
        // Si no hay iconos de Firebase, intentar desde localStorage
        if (iconos.length === 0) {
          const iconosLocal = JSON.parse(localStorage.getItem('subscriptionIcons') || '[]');
          iconos = iconosLocal.map((icono, index) => ({
            id: `local-${index}`,
            nombre: icono.nombre,
            url: icono.url,
            esBase64: true
          }));
        }
        
        if (iconos.length === 0) {
          lista.innerHTML = '';
          noIconos.classList.remove('hidden');
          return;
        }
        
        noIconos.classList.add('hidden');
        lista.innerHTML = '';
        
        iconos.forEach(icono => {
          const div = document.createElement('div');
          div.className = 'bg-[#2a2736] rounded-lg p-3 cursor-pointer hover:bg-[#3a3546] transition-colors';
          div.onclick = () => seleccionarIcono(icono.url);
          div.innerHTML = `
            <img 
              src="${icono.url}" 
              alt="${icono.nombre}" 
              class="w-full h-20 object-contain rounded-lg mb-2"
              onerror="this.src='https://upload.wikimedia.org/wikipedia/commons/thumb/9/9c/Generic_Placeholder.svg/1920px-Generic_Placeholder.svg.png'"
            />
            <p class="text-xs text-center text-gray-300">${icono.nombre}</p>
          `;
          lista.appendChild(div);
        });
      } catch (error) {
        console.error('Error al cargar iconos:', error);
        lista.innerHTML = '<div class="col-span-3 text-center text-red-400">Error al cargar iconos</div>';
      }
    }
    
    // Función para cerrar el selector de iconos
    function cerrarSelectorIconos() {
      document.getElementById('iconos-modal').classList.add('hidden');
    }
    
    // Función para seleccionar un icono
    function seleccionarIcono(url) {
      const logoImg = document.getElementById('subscription-logo');
      logoImg.src = url;
      window.logoData = url;
      document.getElementById('delete-logo-btn').style.display = 'block';
      cerrarSelectorIconos();
    }

    // Función para eliminar el logo
    function handleLogoDelete() {
      const logoImg = document.getElementById('subscription-logo');
      logoImg.src = 'https://upload.wikimedia.org/wikipedia/commons/thumb/9/9c/Generic_Placeholder.svg/1920px-Generic_Placeholder.svg.png';
      window.logoData = null;
      // Ocultar el botón de eliminar cuando se usa el logo genérico
      document.getElementById('delete-logo-btn').style.display = 'none';
    }

  </script>
</head>
<body class="bg-[#0c0a17] text-white font-sans min-h-screen p-5">
  <div class="max-w-md mx-auto">
    <header class="flex justify-between items-center mb-6">
      <button onclick="window.location.href='index.html'" class="text-[#6b6b7b] text-base font-normal hover:text-white">
        Cancelar
      </button>
      <h1 id="pageTitle" class="text-2xl font-bold leading-tight">Editar Suscripción</h1>
      <button id="saveButton" class="text-white text-base font-normal" type="button">Guardar</button>
    </header>

    <section class="bg-[#1f1c2b] rounded-xl p-4 flex items-center space-x-4 mb-6">
      <div class="relative group">
        <div class="w-12 h-12 flex-shrink-0 cursor-pointer rounded-lg overflow-hidden">
          <img id="subscription-logo" alt="Logo de suscripción" class="w-full h-full object-cover" src="https://upload.wikimedia.org/wikipedia/commons/thumb/9/9c/Generic_Placeholder.svg/1920px-Generic_Placeholder.svg.png"/>
        </div>
        <div class="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity duration-200 bg-black/50 rounded-lg">
          <div class="flex flex-col items-center space-y-2">
            <button onclick="mostrarSelectorIconos()" class="text-white hover:text-gray-200">
              <i class="fas fa-image"></i>
              <span class="text-xs">Elegir</span>
            </button>
            <button onclick="handleLogoDelete()" class="text-white hover:text-gray-200" id="delete-logo-btn">
              <i class="fas fa-trash"></i>
              <span class="text-xs">Eliminar</span>
            </button>
          </div>
        </div>
      </div>
      
      <!-- Modal para seleccionar icono -->
      <div id="iconos-modal" class="hidden fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4">
        <div class="bg-[#1f1c2b] rounded-xl p-6 max-w-md w-full max-h-[80vh] overflow-y-auto">
          <div class="flex items-center justify-between mb-4">
            <h2 class="text-xl font-bold text-white">Seleccionar Icono</h2>
            <button onclick="cerrarSelectorIconos()" class="text-gray-400 hover:text-white">
              <i class="fas fa-times"></i>
            </button>
          </div>
          <div id="iconos-lista" class="grid grid-cols-3 gap-4">
            <!-- Los iconos se cargarán aquí -->
          </div>
          <p id="no-iconos-message" class="text-gray-400 text-center mt-4 hidden">No hay iconos guardados. Ve a Configuración > Iconos de Suscripciones para agregar iconos.</p>
        </div>
      </div>
      <div class="flex-1">
        <input type="text" name="name" class="text-white text-lg font-normal mb-1 bg-transparent border-none w-full" placeholder="Name" />
        <input type="text" name="apodo" class="text-gray-400 text-sm font-normal bg-transparent border-none w-full" placeholder="Apodo (para mensajería)" />
      </div>
    </section>

    <section class="bg-[#1f1c2b] rounded-xl divide-y divide-[#2a2736] mb-6">
      <!-- Precio Original en USD -->
      <div class="flex justify-between items-center px-4 py-3">
        <div class="text-white text-base font-normal">Precio original (USD)</div>
        <div class="flex items-center space-x-2">
          <div class="bg-[#3f3f46] rounded-md w-7 h-7 flex items-center justify-center text-white font-semibold text-sm select-none">$</div>
          <input type="number" name="original_price_usd" step="0.01" min="0" class="bg-[#3f3f46] rounded-md px-3 py-1 text-white text-base font-normal w-24" placeholder="0.00" />
        </div>
      </div>
      <!-- Conversión automática a GTQ -->
      <div class="flex justify-between items-center px-4 py-3">
        <div class="text-white text-base font-normal">Conversión (GTQ)</div>
        <div class="flex items-center space-x-2">
          <div class="bg-[#3f3f46] rounded-md w-7 h-7 flex items-center justify-center text-white font-semibold text-sm select-none">Q</div>
          <div class="bg-[#3f3f46] rounded-md px-3 py-1 text-[#6b6b7b] text-base font-normal w-24" id="conversion_display">0.00</div>
        </div>
      </div>
      <!-- Precio Debitado en GTQ -->
      <div class="flex justify-between items-center px-4 py-3">
        <div class="text-white text-base font-normal">Precio debitado (GTQ)</div>
        <div class="flex items-center space-x-2">
          <div class="bg-[#3f3f46] rounded-md w-7 h-7 flex items-center justify-center text-white font-semibold text-sm select-none">Q</div>
          <input type="number" name="debit_price_gtq" step="0.01" min="0" class="bg-[#3f3f46] rounded-md px-3 py-1 text-white text-base font-normal w-24" placeholder="0.00" />
        </div>
      </div>
      <!-- Precio de Cobro en GTQ -->
      <div class="flex justify-between items-center px-4 py-3">
        <div class="text-white text-base font-normal">Precio de cobro (GTQ)</div>
        <div class="flex items-center space-x-2">
          <div class="bg-[#3f3f46] rounded-md w-7 h-7 flex items-center justify-center text-white font-semibold text-sm select-none">Q</div>
          <div class="bg-[#3f3f46] rounded-md px-3 py-1 text-[#6b6b7b] text-base font-normal w-24" id="charge_price_display">0.00</div>
        </div>
      </div>
      <!-- Ganancia automática en GTQ -->
      <div class="flex justify-between items-center px-4 py-3">
        <div class="text-white text-base font-normal">Ganancia (GTQ)</div>
        <div class="flex items-center space-x-2">
          <div class="bg-[#3f3f46] rounded-md w-7 h-7 flex items-center justify-center text-white font-semibold text-sm select-none">Q</div>
          <div class="bg-[#3f3f46] rounded-md px-3 py-1 text-[#6b6b7b] text-base font-normal w-24" id="profit_display">0.00</div>
        </div>
      </div>
    </section>

    <section class="bg-[#1f1c2b] rounded-xl divide-y divide-[#2a2736] mb-6">
      <div class="flex justify-between items-center px-4 py-3">
        <div class="text-white text-base font-normal">Prueba gratuita</div>
        <label class="relative inline-flex items-center cursor-pointer">
          <input type="checkbox" name="free_trial" class="sr-only" />
          <div></div>
        </label>
      </div>
      <div id="freeTrialSection" class="hidden divide-y divide-[#2a2736]">
        <div class="flex justify-between items-center px-4 py-3">
          <div class="text-white text-base font-normal">Fecha de Fin</div>
          <div class="flex items-center space-x-2">
            <input type="date" name="trial_end_date" class="bg-[#3f3f46] rounded-md px-3 py-1 text-white text-base font-normal" />
          </div>
        </div>
      </div>
    </section>

    <section class="bg-[#1f1c2b] rounded-xl divide-y divide-[#2a2736] mb-6" id="regularSubscriptionSection">
      <div class="flex justify-between items-center px-4 py-3">
        <div class="text-white text-base font-normal">Primer pago</div>
        <div class="flex items-center space-x-2">
          <input type="date" name="nextPayment" class="text-[#6b6b7b] text-base font-normal bg-transparent border-none" />
        </div>
      </div>
      <div class="flex justify-between items-center px-4 py-3">
        <div class="text-white text-base font-normal">Ciclo de facturación</div>
        <div class="flex items-center space-x-2">
          <select name="billing" class="text-[#6b6b7b] text-base font-normal bg-transparent border-none">
            <option value="mensual">Mensual</option>
            <option value="trimestral">Trimestral</option>
            <option value="semestral">Semestral</option>
            <option value="anual">Anual</option>
          </select>
        </div>
      </div>
    </section>

    <section class="bg-[#1f1c2b] rounded-xl divide-y divide-[#2a2736] mb-6">
      <div class="flex justify-between items-center px-4 py-3">
        <div class="text-white text-base font-normal">Tipo de suscripción</div>
        <div class="flex items-center space-x-2">
          <select name="list" class="text-[#6b6b7b] text-base font-normal bg-transparent border-none">
            <option value="personal">Personal</option>
            <option value="compartido">Compartido</option>
            <option value="prueba_gratuita">Prueba gratuita</option>
          </select>
        </div>
      </div>
      <div class="flex justify-between items-center px-4 py-3">
        <div class="text-white text-base font-normal">Categoría</div>
        <div class="flex items-center space-x-2">
          <input type="text" name="category" class="text-[#6b6b7b] text-base font-normal bg-transparent border-none" />
        </div>
      </div>
    </section>

    <!-- Sección de Suscripción Compartida (inicialmente oculta) -->
    <div id="seccion-compartida" class="hidden space-y-4 mb-6">
      <div>
        <label class="block text-gray-400 text-sm mb-2">Suscripción Compartida</label>
        <div class="bg-[#2a2736] rounded-lg p-4">
          <div class="mb-4">
            <label class="block text-gray-400 text-sm mb-2">Perfiles</label>
            <input type="number" id="perfiles-input" class="w-full bg-transparent border-none text-white text-lg focus:outline-none [appearance:textfield] [&::-webkit-outer-spin-button]:appearance-none [&::-webkit-inner-spin-button]:appearance-none" placeholder="Ingrese número de perfiles" min="1" max="7">
          </div>
          <div id="perfiles-container" class="flex justify-center space-x-2">
            <!-- Los iconos se generarán aquí dinámicamente -->
          </div>
        </div>
      </div>
    </div>

    <section>
      <label class="block text-[#6b6b7b] text-xs font-semibold mb-1 tracking-widest" for="notes">NOTAS</label>
      <textarea class="w-full bg-[#1f1c2b] rounded-xl p-4 text-white text-base font-normal resize-none placeholder-[#6b6b7b] focus:outline-none" id="notes" placeholder="" rows="6"></textarea>
    </section>
  </div>
  <div class="fixed bottom-0 left-0 right-0 text-center text-[#6b6b7b] text-[10px] pb-1 pointer-events-none z-40">
    <span id="app-version">v1.0.52</span>
  </div>
</body>
</html>


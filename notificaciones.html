<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <script>if (location.protocol === 'http:' && location.hostname !== 'localhost' && !location.hostname.match(/^127\./)) { location.replace('https://' + location.host + location.pathname + location.search); }</script>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover"/>
  <title>Notificaciones - App Suscripciones</title>
  <meta name="description" content="Configuración de notificaciones push y tipos de recordatorio">
  <meta name="theme-color" content="#1B1930">
  <link rel="manifest" href="./manifest.json">
  <link rel="apple-touch-icon" href="./icons/icon-192x192.png">
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet"/>
  
  <script src="onesignal-config.js"></script>
  <script src="onesignal-config-local.js" onerror="console.log('onesignal-config-local.js no encontrado')"></script>
  
  <!-- OneSignal SDK v16 - snippet recomendado con notifyButton -->
  <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
  <script>
    window.OneSignalDeferred = window.OneSignalDeferred || [];
    OneSignalDeferred.push(async function(OneSignal) {
      if (typeof ONESIGNAL_CONFIG === 'undefined' || !ONESIGNAL_CONFIG.appId) return;
      await OneSignal.init({
        appId: ONESIGNAL_CONFIG.appId,
        safari_web_id: ONESIGNAL_CONFIG.safariWebId || undefined,
        notifyButton: { enable: true },
        allowLocalhostAsSecureOrigin: true,
      });
    });
  </script>
  <script src="onesignal-service.js"></script>
  <script src="onesignal-session.js"></script>
  <script src="onesignal-notifications.js"></script>
  
  <style>
    body, html { overflow-x: hidden !important; max-width: 100vw; box-sizing: border-box; }
    body::-webkit-scrollbar, html::-webkit-scrollbar { display: none !important; }
    body { font-family: 'Inter', sans-serif; min-height: 100vh; -ms-overflow-style: none; scrollbar-width: none; }
    html, body { overflow-y: auto !important; -webkit-overflow-scrolling: touch !important; }
  </style>
</head>
<body class="bg-[#0D0A1A] text-white min-h-screen flex flex-col pb-24">
  <div class="container mx-auto px-4 pt-4">
    <div class="flex items-center justify-between mb-6">
      <button onclick="window.location.href='settings.html'" class="text-gray-400 hover:text-white">
        <i class="fas fa-arrow-left text-xl"></i>
      </button>
      <h1 class="text-xl font-bold">Notificaciones</h1>
      <div class="w-8"></div>
    </div>

    <!-- Plataforma -->
    <div class="bg-[#1B1930] rounded-xl p-6 mb-6">
      <h2 class="text-lg font-bold mb-4">Plataforma</h2>
      <p class="text-gray-400 text-sm mb-3">Elige cómo quieres recibir los recordatorios de pago.</p>
      <select id="notification-platform" class="w-full bg-[#2a2736] text-white rounded-lg px-4 py-3 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-purple-500">
        <option value="onesignal">Web Push (OneSignal)</option>
      </select>
    </div>

    <!-- Tipo de notificación -->
    <div class="bg-[#1B1930] rounded-xl p-6 mb-6">
      <h2 class="text-lg font-bold mb-4">Tipo de recordatorio</h2>
      <p class="text-gray-400 text-sm mb-4">Se aplican a todas las suscripciones al guardar o crear una.</p>
      
      <div class="space-y-4">
        <label class="flex items-center justify-between bg-[#2a2736] rounded-lg p-3 cursor-pointer hover:bg-[#33314a]">
          <span class="text-sm font-medium">1 día antes del pago</span>
          <div class="flex items-center gap-2">
            <input type="time" id="time-1day" class="bg-[#3f3f46] rounded px-2 py-1 text-white text-sm" value="09:00" />
            <input type="checkbox" id="cb-1day" class="rounded" />
          </div>
        </label>
        <label class="flex items-center justify-between bg-[#2a2736] rounded-lg p-3 cursor-pointer hover:bg-[#33314a]">
          <span class="text-sm font-medium">2 días antes del pago</span>
          <div class="flex items-center gap-2">
            <input type="time" id="time-2days" class="bg-[#3f3f46] rounded px-2 py-1 text-white text-sm" value="09:00" />
            <input type="checkbox" id="cb-2days" class="rounded" />
          </div>
        </label>
        <label class="flex items-center justify-between bg-[#2a2736] rounded-lg p-3 cursor-pointer hover:bg-[#33314a]">
          <span class="text-sm font-medium">El mismo día del pago</span>
          <div class="flex items-center gap-2">
            <input type="time" id="time-sameday" class="bg-[#3f3f46] rounded px-2 py-1 text-white text-sm" value="09:00" />
            <input type="checkbox" id="cb-sameday" class="rounded" />
          </div>
        </label>
        <div class="bg-[#2a2736] rounded-lg p-3 space-y-2">
          <div class="flex items-center justify-between">
            <span class="text-sm font-medium">Días personalizados antes</span>
            <input type="checkbox" id="cb-custom" class="rounded" />
          </div>
          <div class="flex items-center gap-2 flex-wrap">
            <input type="number" id="custom-days" class="bg-[#3f3f46] rounded px-2 py-1 text-white text-sm w-20" placeholder="días" min="1" max="30" disabled />
            <input type="time" id="time-custom" class="bg-[#3f3f46] rounded px-2 py-1 text-white text-sm" value="09:00" disabled />
          </div>
        </div>
        <div class="bg-[#2a2736] rounded-lg p-3 space-y-2">
          <div class="flex items-center justify-between">
            <span class="text-sm font-medium">Fecha y hora personalizada (cada mes)</span>
            <input type="checkbox" id="cb-customdate" class="rounded" />
          </div>
          <div class="flex items-center gap-2 flex-wrap">
            <input type="date" id="date-customdate" class="bg-[#3f3f46] rounded px-2 py-1 text-white text-sm" disabled />
            <input type="time" id="time-customdate" class="bg-[#3f3f46] rounded px-2 py-1 text-white text-sm" value="09:00" disabled />
          </div>
        </div>
      </div>
      <button type="button" onclick="saveNotificationPreferences()" class="mt-4 w-full bg-purple-600 hover:bg-purple-700 px-4 py-3 rounded-lg text-sm font-medium">
        Guardar preferencias de recordatorios
      </button>
      <p id="prefs-status" class="text-xs mt-2 text-gray-400"></p>
    </div>

    <!-- OneSignal: suscripción y clave REST -->
    <div class="bg-[#1B1930] rounded-xl p-6 mb-6">
      <h2 class="text-lg font-bold mb-4">Push (OneSignal)</h2>
      <div id="onesignal-status" class="text-yellow-400 mb-3 text-sm">Verificando...</div>
      <div class="flex flex-col gap-2">
        <button type="button" onclick="subscribeToOneSignal()" class="bg-purple-600 hover:bg-purple-700 px-4 py-2 rounded-lg text-sm w-full">
          Suscribirse a notificaciones push
        </button>
        <button type="button" onclick="checkOneSignalStatus()" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg text-sm w-full">
          Verificar estado
        </button>
        <button type="button" onclick="sendTestNotification1Min()" class="bg-amber-600 hover:bg-amber-700 px-4 py-2 rounded-lg text-sm w-full">
          Enviar notificación en 1 min (probar)
        </button>
      </div>
      <p id="test-1min-status" class="text-xs mt-2 text-gray-400"></p>
      <div class="mt-4 p-3 bg-[#2a2736] rounded-lg border border-gray-600">
        <label class="block text-sm font-medium text-gray-300 mb-2">Clave REST API (recordatorios al guardar)</label>
        <p class="text-xs text-gray-400 mb-2">OneSignal → Settings → Keys &amp; IDs → REST API Key.</p>
        <input type="password" id="onesignal-rest-api-key-input" placeholder="Pega la clave REST API" class="w-full px-3 py-2 rounded bg-[#1a1722] border border-gray-600 text-sm text-gray-200 placeholder-gray-500 mb-2"/>
        <button type="button" onclick="saveOneSignalRestApiKey()" class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded-lg text-sm w-full">Guardar clave</button>
        <p id="onesignal-key-status" class="text-xs mt-2 text-gray-400"></p>
      </div>
      <p class="text-xs text-gray-500 mt-3">✅ Funciona incluso con el navegador cerrado. Gratis hasta 10.000 suscriptores.</p>
    </div>
  </div>

  <nav class="fixed bottom-0 left-0 right-0 bg-[#1B1930]/80 backdrop-blur-md flex justify-between items-center px-16 py-4 border-t border-white/10 text-white/50 text-xs z-50">
    <button class="flex flex-col items-center space-y-1" onclick="navigateTo('index.html')"><i class="fas fa-moon text-lg"></i><span>Subscriptions</span></button>
    <button class="flex flex-col items-center space-y-1" onclick="navigateTo('calendar.html')"><i class="fas fa-th-large text-xl"></i><span>Calendar</span></button>
    <button class="flex flex-col items-center space-y-1" onclick="navigateTo('personas.html')"><i class="fas fa-users text-lg"></i><span>Personas</span></button>
    <button class="flex flex-col items-center space-y-1 text-white" onclick="navigateTo('settings.html')"><i class="fas fa-cog text-lg"></i><span>Settings</span></button>
  </nav>

  <script>
    const PREFS_KEY = 'notification_preferences';

    function getPrefs() {
      try {
        const raw = localStorage.getItem(PREFS_KEY);
        if (!raw) return { platform: 'onesignal', types: [] };
        return JSON.parse(raw);
      } catch (e) { return { platform: 'onesignal', types: [] }; }
    }

    function loadNotificationPreferences() {
      const prefs = getPrefs();
      const platform = document.getElementById('notification-platform');
      if (platform) platform.value = prefs.platform || 'onesignal';

      const types = prefs.types || [];
      function hasType(prefix) {
        return types.some(t => t === prefix || t.startsWith(prefix + '_'));
      }
      function getTime(prefix) {
        const t = types.find(x => x.startsWith(prefix + '_'));
        if (!t) return '09:00';
        const part = t.split('_')[1];
        return part && part.includes(':') ? part : '09:00';
      }
      function getCustomDays() {
        const t = types.find(x => x.startsWith('custom_') && !x.startsWith('customdate_'));
        if (!t) return '';
        const parts = t.split('_');
        return parts[1] || '';
      }
      function getCustomDate() {
        const t = types.find(x => x.startsWith('customdate_'));
        if (!t) return '';
        const parts = t.split('_');
        if (parts.length >= 5) return parts[1] + '-' + (parts[2]||'').padStart(2,'0') + '-' + (parts[3]||'').padStart(2,'0');
        return '';
      }
      function getCustomDateTime() {
        const t = types.find(x => x.startsWith('customdate_'));
        if (!t) return '09:00';
        const parts = t.split('_');
        return parts[4] || '09:00';
      }

      document.getElementById('cb-1day').checked = hasType('1day');
      document.getElementById('cb-2days').checked = hasType('2days');
      document.getElementById('cb-sameday').checked = hasType('sameday');
      document.getElementById('time-1day').value = getTime('1day');
      document.getElementById('time-2days').value = getTime('2days');
      document.getElementById('time-sameday').value = getTime('sameday');

      const customChecked = types.some(t => t.startsWith('custom_') && !t.startsWith('customdate_'));
      document.getElementById('cb-custom').checked = customChecked;
      document.getElementById('custom-days').value = getCustomDays();
      document.getElementById('custom-days').disabled = !customChecked;
      document.getElementById('time-custom').value = (types.find(t => t.startsWith('custom_') && !t.startsWith('customdate_')) || '').split('_')[2] || '09:00';
      document.getElementById('time-custom').disabled = !customChecked;

      const customDateChecked = types.some(t => t.startsWith('customdate_'));
      document.getElementById('cb-customdate').checked = customDateChecked;
      document.getElementById('date-customdate').value = getCustomDate();
      document.getElementById('date-customdate').disabled = !customDateChecked;
      document.getElementById('time-customdate').value = getCustomDateTime();
      document.getElementById('time-customdate').disabled = !customDateChecked;
    }

    function saveNotificationPreferences() {
      const types = [];
      if (document.getElementById('cb-1day').checked)
        types.push('1day_' + (document.getElementById('time-1day').value || '09:00'));
      if (document.getElementById('cb-2days').checked)
        types.push('2days_' + (document.getElementById('time-2days').value || '09:00'));
      if (document.getElementById('cb-sameday').checked)
        types.push('sameday_' + (document.getElementById('time-sameday').value || '09:00'));
      if (document.getElementById('cb-custom').checked) {
        const days = document.getElementById('custom-days').value;
        const time = document.getElementById('time-custom').value || '09:00';
        if (days) types.push('custom_' + days + '_' + time);
      }
      if (document.getElementById('cb-customdate').checked) {
        const d = document.getElementById('date-customdate').value;
        const time = document.getElementById('time-customdate').value || '09:00';
        if (d) {
          const [y, m, day] = d.split('-');
          types.push('customdate_' + y + '_' + m + '_' + day + '_' + time);
        }
      }
      const platform = document.getElementById('notification-platform').value || 'onesignal';
      const prefs = { platform, types };
      localStorage.setItem(PREFS_KEY, JSON.stringify(prefs));
      const el = document.getElementById('prefs-status');
      el.textContent = '✅ Preferencias guardadas. Se usarán al crear o editar suscripciones.';
      el.className = 'text-xs mt-2 text-green-400';
    }

    document.getElementById('cb-custom').addEventListener('change', function() {
      document.getElementById('custom-days').disabled = !this.checked;
      document.getElementById('time-custom').disabled = !this.checked;
    });
    document.getElementById('cb-customdate').addEventListener('change', function() {
      document.getElementById('date-customdate').disabled = !this.checked;
      document.getElementById('time-customdate').disabled = !this.checked;
    });

    async function checkOneSignalStatus() {
      const el = document.getElementById('onesignal-status');
      if (typeof oneSignalService === 'undefined' || !ONESIGNAL_CONFIG || !ONESIGNAL_CONFIG.appId) {
        el.innerHTML = '<span class="text-yellow-400">OneSignal no configurado (revisa onesignal-config.js)</span>';
        return;
      }
      try {
        if (!oneSignalService.initialized)
          await oneSignalService.initialize(ONESIGNAL_CONFIG.appId, ONESIGNAL_CONFIG.safariWebId);
        const info = await oneSignalService.getUserInfo();
        if (info && info.subscribed) {
          el.innerHTML = '<span class="text-green-400">✅ Suscrito. Recibirás recordatorios push.</span>';
        } else if (info && info.permission === 'denied') {
          el.innerHTML = '<span class="text-red-400">Permisos denegados. Actívalos en el navegador.</span>';
        } else {
          el.innerHTML = '<span class="text-yellow-400">No suscrito. Pulsa "Suscribirse a notificaciones push".</span>';
        }
      } catch (err) {
        el.innerHTML = '<span class="text-red-400">Error: ' + (err.message || 'desconocido') + '</span>';
      }
    }

    async function subscribeToOneSignal() {
      if (typeof oneSignalService === 'undefined' || !ONESIGNAL_CONFIG || !ONESIGNAL_CONFIG.appId) {
        alert('OneSignal no está configurado.');
        return;
      }
      try {
        if (!oneSignalService.initialized)
          await oneSignalService.initialize(ONESIGNAL_CONFIG.appId, ONESIGNAL_CONFIG.safariWebId);
        const ok = await oneSignalService.subscribe();
        if (ok) {
          document.getElementById('onesignal-status').innerHTML = '<span class="text-green-400">✅ Suscrito correctamente.</span>';
        } else {
          document.getElementById('onesignal-status').innerHTML = '<span class="text-yellow-400">Permisos denegados o pendientes.</span>';
        }
      } catch (err) {
        document.getElementById('onesignal-status').innerHTML = '<span class="text-red-400">Error: ' + (err.message || '') + '</span>';
      }
    }

    function saveOneSignalRestApiKey() {
      const input = document.getElementById('onesignal-rest-api-key-input');
      const statusEl = document.getElementById('onesignal-key-status');
      const key = (input && input.value) ? input.value.trim() : '';
      if (!key) {
        statusEl.textContent = 'Escribe o pega la clave antes de guardar.';
        statusEl.className = 'text-xs mt-2 text-yellow-400';
        return;
      }
      try {
        localStorage.setItem('onesignal_rest_api_key', key);
        statusEl.textContent = '✅ Clave guardada. Los recordatorios se enviarán al guardar suscripciones.';
        statusEl.className = 'text-xs mt-2 text-green-400';
        input.value = '';
        input.placeholder = 'Clave guardada';
      } catch (e) {
        statusEl.textContent = '❌ No se pudo guardar.';
        statusEl.className = 'text-xs mt-2 text-red-400';
      }
    }

    async function sendTestNotification1Min() {
      const statusEl = document.getElementById('test-1min-status');
      statusEl.textContent = 'Enviando...';
      statusEl.className = 'text-xs mt-2 text-yellow-400';
      if (typeof OneSignalNotifications === 'undefined' || !OneSignalNotifications.sendTestNotificationIn1Min) {
        statusEl.textContent = 'No se pudo cargar el módulo de notificaciones. Recarga la página.';
        statusEl.className = 'text-xs mt-2 text-red-400';
        return;
      }
      try {
        const result = await OneSignalNotifications.sendTestNotificationIn1Min();
        if (result.ok) {
          statusEl.textContent = '✅ Programada. En 1 minuto te llegará una notificación de prueba.';
          statusEl.className = 'text-xs mt-2 text-green-400';
        } else {
          statusEl.textContent = '❌ ' + (result.error || 'Error al programar.');
          statusEl.className = 'text-xs mt-2 text-red-400';
        }
      } catch (err) {
        statusEl.textContent = '❌ Error: ' + (err.message || 'desconocido');
        statusEl.className = 'text-xs mt-2 text-red-400';
      }
    }

    function navigateTo(page) {
      if (window.navigating) return;
      window.navigating = true;
      window.location.href = page;
    }

    document.addEventListener('DOMContentLoaded', function() {
      loadNotificationPreferences();
      if (localStorage.getItem('onesignal_rest_api_key')) {
        document.getElementById('onesignal-key-status').textContent = '✅ Tienes una clave guardada.';
        document.getElementById('onesignal-key-status').className = 'text-xs mt-2 text-green-400';
      }
      setTimeout(checkOneSignalStatus, 800);
    });
  </script>
</body>
</html>
